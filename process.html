<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏ß‡∏•‡∏≤ - TAS-SPB</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f8fafc; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 700px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; }
        .btn-process { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; padding: 15px 30px; border-radius: 30px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin: 20px 0; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3); transition: transform 0.2s; }
        .btn-process:active { transform: scale(0.95); }
        .btn-process:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }
        .log-box { text-align: left; background: #1e293b; color: #10b981; border-radius: 10px; padding: 15px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; border: 1px solid #e2e8f0; }
        .back-btn { text-decoration: none; color: #64748b; font-weight: bold; display: inline-block; margin-bottom: 20px; }
        .highlight { color: #fbbf24; } /* ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç */
        .error { color: #ef4444; } /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Error */
    </style>
    
    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <a href="menu.html" class="back-btn">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>

    <div class="container">
        <h2>üîÑ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Auto Sync)</h2>
        <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</b> ‡∏à‡∏≤‡∏Å TimeStamp <br>‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á 2 ‡πÅ‡∏´‡∏•‡πà‡∏á</p>
        
        <button id="btnStart" class="btn-process" onclick="startProcess()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
        
        <div class="log-box" id="logDisplay">
            > ‡∏£‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...
        </div>
    </div>

    <script>
        const user = checkAuth(); // ‡πÄ‡∏ä‡πá‡∏Ñ Level 1

        function log(msg, type = 'normal') {
            const box = document.getElementById('logDisplay');
            let colorClass = '';
            if(type === 'highlight') colorClass = 'class="highlight"';
            if(type === 'error') colorClass = 'class="error"';
            
            box.innerHTML += `<div ${colorClass}>> ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á Date ‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö DB)
        function formatDateDB(date) {
            const pad = (n) => String(n).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á Date ‡πÄ‡∏õ‡πá‡∏ô DDMMYYYY (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö URL)
        function formatDateURL(date) {
            const pad = (n) => String(n).padStart(2, '0');
            return `${pad(date.getDate())}${pad(date.getMonth() + 1)}${date.getFullYear()}`;
        }

        async function startProcess() {
            const btn = document.getElementById('btnStart');
            btn.disabled = true;
            document.getElementById('logDisplay').innerHTML = '<div>> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£...</div>';

            try {
                // 1. ‡∏î‡∏∂‡∏á Base URL
                const { data: settingData } = await sbClient.from(TAS_CONFIG.TABLE_SETTINGS)
                    .select('value').eq('key', 'data_url').single();
                
                if (!settingData || !settingData.value) {
                    throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö 'data_url' ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á Settings");
                }
                const baseURL = settingData.value.endsWith('/') ? settingData.value : settingData.value + '/';
                log(`Base URL: ${baseURL}`);

                // 2. ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô TimeStamp
                log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...");
                const { data: latestRecord, error: errLatest } = await sbClient
                    .from(TAS_CONFIG.TABLE_TARGET) // TimeStamp
                    .select('work_date')
                    .order('work_date', { ascending: false })
                    .limit(1)
                    .single();

                let startDate = new Date();
                if (latestRecord && latestRecord.work_date) {
                    startDate = new Date(latestRecord.work_date);
                    log(`üìÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDateDB(startDate)}`, 'highlight');
                } else {
                    log("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏à‡∏≤‡∏Å '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'");
                }

                // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏à‡∏≤‡∏Å StartDate ‡∏ñ‡∏∂‡∏á Today
                const today = new Date();
                today.setHours(0,0,0,0);
                startDate.setHours(0,0,0,0);

                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏π‡∏õ (Copy ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å)
                let loopDate = new Date(startDate); 

                while (loopDate <= today) {
                    const dateDBStr = formatDateDB(loopDate);   // 2025-12-29
                    const dateURLStr = formatDateURL(loopDate); // 29122025
                    
                    log(`-----------------------------------`);
                    log(`‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateDBStr}...`, 'highlight');

                    // --- 3.1 ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å (External) ---
                    let externalData = [];
                    const fullUrl = `${baseURL}${dateURLStr}`;
                    // log(`   Request: ${fullUrl}`); // ‡πÅ‡∏™‡∏î‡∏á URL ‡∏ó‡∏µ‡πà‡∏¢‡∏¥‡∏á‡πÑ‡∏õ
                    
                    try {
                        const res = await fetch(fullUrl);
                        if (res.ok) {
                            externalData = await res.json();
                            log(`   ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å: ‡∏û‡∏ö ${externalData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                        } else {
                            log(`   ‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Status: ${res.status})`);
                        }
                    } catch (e) {
                        log(`   ‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ URL ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏Ç‡πâ‡∏≤‡∏°)`, 'error');
                    }

                    // --- 3.2 ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (TimeStampPlus) ---
                    // ‡πÄ‡∏ä‡πá‡∏Ñ config ‡∏Å‡πà‡∏≠‡∏ô
                    if (!TAS_CONFIG.TABLE_SOURCE) throw new Error("Config 'TABLE_SOURCE' ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á");

                    const { data: internalData, error: errInt } = await sbClient
                        .from(TAS_CONFIG.TABLE_SOURCE)
                        .select('*')
                        .eq('work_date', dateDBStr); // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏õ‡∏≠‡∏¢‡∏π‡πà

                    if (errInt) {
                        log(`   ‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${errInt.message}`, 'error');
                    } else {
                        log(`   ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Web): ‡∏û‡∏ö ${internalData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                    }

                    // --- 3.3 ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Merge) ---
                    const mergedMap = {};
                    
                    const processRecord = (rec) => {
                        const key = `${rec.personnel_id}`; // ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô key (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏•‡∏π‡∏õ‡∏ô‡∏µ‡πâ)
                        if (!mergedMap[key]) {
                            mergedMap[key] = {
                                personnel_id: rec.personnel_id,
                                full_name: rec.full_name || rec.name,
                                work_date: dateDBStr, // ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏õ
                                time_in: rec.time_in,
                                time_out: rec.time_out
                            };
                        } else {
                            const current = mergedMap[key];
                            // Min Time In
                            if (rec.time_in) {
                                if (!current.time_in || rec.time_in < current.time_in) current.time_in = rec.time_in;
                            }
                            // Max Time Out
                            if (rec.time_out) {
                                if (!current.time_out || rec.time_out > current.time_out) current.time_out = rec.time_out;
                            }
                        }
                    };

                    // ‡∏£‡∏ß‡∏° 2 ‡πÅ‡∏´‡∏•‡πà‡∏á
                    if (externalData.length > 0) externalData.forEach(processRecord);
                    if (internalData && internalData.length > 0) internalData.forEach(processRecord);

                    const finalData = Object.values(mergedMap);

                    // --- 3.4 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Upsert) ---
                    if (finalData.length > 0) {
                        // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏° ID ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TimeStamp table)
                        const recordsToSave = finalData.map(item => ({
                            id: generateID(), // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥ unique key ‡∏°‡∏±‡∏ô‡∏à‡∏∞ update ‡πÅ‡∏ó‡∏ô)
                            personnel_id: item.personnel_id,
                            full_name: item.full_name,
                            work_date: item.work_date,
                            time_in: item.time_in,
                            time_out: item.time_out,
                            verified: 0
                        }));

                        const { error: errUpsert } = await sbClient
                            .from(TAS_CONFIG.TABLE_TARGET)
                            .upsert(recordsToSave, { onConflict: 'personnel_id, work_date' });

                        if (errUpsert) {
                            log(`   ‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${errUpsert.message}`, 'error');
                        } else {
                            log(`   üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${recordsToSave.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                        }
                    } else {
                        log(`   (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)`);
                    }

                    // ‡∏Ç‡∏¢‡∏±‡∏ö‡πÑ‡∏õ‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    loopDate.setDate(loopDate.getDate() + 1);
                } // End While Loop

                log(`-----------------------------------`);
                log(`‚úÖ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!`, 'highlight');
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success');

            } catch (err) {
                console.error(err);
                log(`‚ùå Error: ${err.message}`, 'error');
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
