<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>รายงานประจำวัน - TAS-SPB</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="TAS-SPB">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #525659; --a4-w: 210mm; --a4-h: 297mm; }
        * { box-sizing: border-box; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .controls-bar { width: 100%; max-width: var(--a4-w); background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); flex-wrap: wrap; }
        .date-input { padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Sarabun'; }
        .btn { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-load { background: var(--primary); }
        .btn-print { background: #333; }
        .btn-share { background: #10b981; }
        .back-link { text-decoration: none; color: #666; font-weight: bold; margin-right: 10px; }
        #reportContainer { width: 100%; display: flex; flex-direction: column; align-items: center; }
        .paper { width: var(--a4-w); min-height: var(--a4-h); background: white; padding: 20mm; margin-bottom: 20px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); position: relative; display: flex; flex-direction: column; }
        .rpt-header { text-align: center; margin-bottom: 15px; line-height: 1.2; }
        .rpt-title { font-size: 16pt; font-weight: bold; }
        .rpt-date { font-size: 15pt; margin: 5px 0; }
        .rpt-school { font-size: 15pt; }
        .rpt-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .rpt-table th, .rpt-table td { border: 1px solid #000; padding: 4px 5px; font-size: 14pt; }
        .rpt-table th { background-color: #f0f0f0; text-align: center; }
        .rpt-table td { vertical-align: middle; }

        /* การจัดการท้ายกระดาษแบบใหม่ */
        .footer-layout { display: flex; justify-content: space-between; align-items: flex-start; margin-top: 15px; font-size: 14pt; width: 100%; border: 0px solid red; }
        .footer-summary { flex: 1; text-align: left; line-height: 1.6; padding-left: 2px; }
        .footer-sign-col { flex: 1; display: flex; justify-content: flex-end; }
        .sign-box { text-align: left; min-width: fit-content; line-height: 1.6; }

        @media print {
            body { background: white; padding: 0; }
            .controls-bar { display: none; }
            .paper { box-shadow: none; margin: 0 !important; width: 100% !important; padding: 15mm !important; page-break-after: always; }
        }
    </style>
    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <div class="controls-bar">
        <a href="menu.html" class="back-link"><i class="fas fa-arrow-left"></i> กลับเมนู</a>
        <label>วันที่:</label>
        <input type="date" id="filterDate" class="date-input">
        <button class="btn btn-load" onclick="generateReport()">
            <i class="fas fa-sync-alt"></i> โหลดข้อมูล
        </button>
        <div style="flex-grow:1"></div>
        <button id="btnPrint" class="btn btn-print" style="display:none;" onclick="window.print()">
            <i class="fas fa-print"></i> พิมพ์ / PDF
        </button>
        <button id="btnShare" class="btn btn-share" style="display:none;" onclick="shareAsPDF()">
            <i class="fas fa-share-alt"></i> แชร์ PDF
        </button>
    </div>
    <div id="reportContainer">
        <div class="paper"><div style="text-align:center; padding-top:100px; color:#999;"><h3>กรุณาเลือกวันที่แล้วกด "โหลดข้อมูล"</h3></div></div>
    </div>

    <script>
        let appSettings = {};
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];
            await loadSettings();
        });
        async function loadSettings() {
            try {
                const { data } = await sbClient.from(TAS_CONFIG.TABLE_SETTINGS).select('*');
                if (data) data.forEach(item => appSettings[item.key] = item.value);
            } catch (e) { console.error(e); }
        }
        function formatThaiDate(dateStr) {
            const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            const d = new Date(dateStr);
            return `วัน${['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'][d.getDay()]}ที่ ${d.getDate()} ${months[d.getMonth()]} พ.ศ.${d.getFullYear() + 543}`;
        }
        function truncateType(str) {
            return str.length > 35 ? str.substring(0, 35) + "ฯ" : str;
        }
        async function generateReport() {
            const date = document.getElementById('filterDate').value;
            const container = document.getElementById('reportContainer');
            container.innerHTML = '<div class="paper" style="text-align:center; padding-top:100px;">กำลังประมวลผล...</div>';
            try {
                const { data: users } = await sbClient.from(TAS_CONFIG.TABLE_USER).select('*').order('personnel_id');
                const { data: att } = await sbClient.from(TAS_CONFIG.TABLE_TARGET).select('*').eq('work_date', date);
                const { data: leaves } = await sbClient.from('Leave_records').select('*').eq('leave_date', date);
                if (!users || users.length === 0) { container.innerHTML = '<div class="paper" style="text-align:center; padding-top:100px;">ไม่พบข้อมูลพนักงาน</div>'; return; }
                const attMap = {}; att?.forEach(x => attMap[x.personnel_id] = x);
                const leaveMap = {}; leaves?.forEach(x => leaveMap[x.personnel_id] = x);
                const groups = {};
                users.forEach(u => {
                    const pType = u.personnel_type || 'ทั่วไป';
                    if (!groups[pType]) groups[pType] = [];
                    const ts = attMap[u.personnel_id];
                    const lv = leaveMap[u.personnel_id];
                    let status = 'absent', note = '', tIn = '', tOut = '';
                    if (ts) { status = 'present'; tIn = ts.time_in ? ts.time_in.slice(0, 5) : ''; tOut = ts.time_out ? ts.time_out.slice(0, 5) : ''; if (tIn > (appSettings['Late'] || '08:30')) note += 'มาสาย '; } 
                    else if (lv) { status = (lv.leave_type.includes('ราชการ')) ? 'trip' : 'leave'; note = lv.leave_type; }
                    groups[pType].push({ ...u, tIn, tOut, status, note });
                });
                container.innerHTML = '';
                Object.keys(groups).sort().forEach(type => {
                    const list = groups[type];
                    const present = list.filter(x => x.status === 'present').length;
                    const trip = list.filter(x => x.status === 'trip').length;
                    const absent = list.filter(x => x.status === 'leave' || x.status === 'absent').length;
                    const page = document.createElement('div');
                    page.className = 'paper';
                    page.innerHTML = `
                        <div class="rpt-header">
                            <div class="rpt-title">บันทึกการลงเวลาปฏิบัติงานของ${truncateType(type)}</div>
                            <div class="rpt-date">${formatThaiDate(date)}</div>
                            <div class="rpt-school">${appSettings['school_name'] || ''}</div>
                        </div>
                        <table class="rpt-table">
                            <thead><tr><th width="50">ที่</th><th>ชื่อ-สกุล</th><th width="80">มา</th><th width="80">กลับ</th><th>หมายเหตุ</th></tr></thead>
                            <tbody>${list.map((u, i) => `<tr><td align="center">${i+1}</td><td>${u.name}</td><td align="center">${u.tIn}</td><td align="center">${u.tOut}</td><td style="font-size:12pt;">${u.note}</td></tr>`).join('')}</tbody>
                        </table>
                        <div class="footer-layout">
                            <div class="footer-summary">
                                ${type} ทั้งหมด ${list.length} คน<br>
                                ตำแหน่งว่าง - คน<br>
                                ไปราชการ ${trip} คน<br>
                                มาสาย ${list.filter(x => x.note.includes('มาสาย')).length} คน<br>
                                ยืมตัวมาช่วยราชการ - คน<br>
                                มาปฏิบัติราชการ ${present + trip} คน<br>
                                ไม่มาปฏิบัติราชการ ${absent} คน
                            </div>
                            <div class="footer-sign-col">
                                <div class="sign-box">
                                    <br>
                                    (....................................................)<br>
                                    (${appSettings['signer_name'] || ''})<br>
                                    ${appSettings['signer_position'] || ''}
                                </div>
                            </div>
                        </div>`;
                    container.appendChild(page);
                });
                document.getElementById('btnPrint').style.display = 'flex';
                document.getElementById('btnShare').style.display = 'flex';
            } catch (e) { container.innerHTML = 'Error: ' + e.message; }
        }
        async function shareAsPDF() {
            const date = document.getElementById('filterDate').value;
            const element = document.getElementById('reportContainer');
            Swal.fire({ title: 'กำลังเตรียมไฟล์ PDF...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
            const opt = { margin: 0, filename: `Report_${date}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            try {
                const pdfBlob = await html2pdf().from(element).set(opt).output('blob');
                const file = new File([pdfBlob], `Report_${date}.pdf`, { type: 'application/pdf' });
                if (navigator.share) { await navigator.share({ files: [file], title: 'รายงานประจำวัน' }); Swal.close(); } 
                else { const url = URL.createObjectURL(pdfBlob); const a = document.createElement('a'); a.href = url; a.download = `Report_${date}.pdf`; a.click(); Swal.fire('สำเร็จ', 'ดาวน์โหลดแล้ว', 'success'); }
            } catch (e) { Swal.fire('Error', e.message, 'error'); }
        }
    </script>
</body>
</html>
