<!DOCTYPE html>
<html lang="th">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô - TAS-SPB</title>
        <link rel="icon" type="image/png" href="favicon.png">

        <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap"
            rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="icon" type="image/png" href="favicon.png">
        <link rel="apple-touch-icon" href="favicon.png">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <meta name="apple-mobile-web-app-title" content="TAS-SPB">
        <style>
            :root {
                --primary: #4f46e5;
                --bg: #525659;
                --a4-w: 210mm;
                --a4-h: 297mm;
            }

            * {
                box-sizing: border-box;
            }

            body {
                font-family: 'Sarabun', sans-serif;
                background: var(--bg);
                margin: 0;
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            /* --- UI Controls --- */
            .controls-bar {
                width: 100%;
                max-width: var(--a4-w);
                background: white;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                display: flex;
                gap: 10px;
                align-items: center;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            }

            .date-input {
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-family: 'Sarabun';
            }

            .btn {
                padding: 8px 15px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                color: white;
                font-weight: bold;
            }

            .btn-load {
                background: var(--primary);
            }

            .btn-print {
                background: #333;
            }

            .back-link {
                text-decoration: none;
                color: #666;
                font-weight: bold;
                margin-right: 10px;
            }

            /* --- Paper Styles --- */
            .paper {
                width: var(--a4-w);
                min-height: var(--a4-h);
                background: white;
                padding: 20mm;
                margin-bottom: 20px;
                box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
                position: relative;
                page-break-after: always;
            }

            /* Header */
            .rpt-header {
                text-align: center;
                margin-bottom: 15px;
                line-height: 1.2;
            }

            .rpt-title {
                font-size: 18pt;
                font-weight: bold;
            }

            .rpt-date {
                font-size: 16pt;
                margin: 5px 0;
            }

            .rpt-school {
                font-size: 16pt;
            }

            /* Table */
            .rpt-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 10px;
            }

            .rpt-table th,
            .rpt-table td {
                border: 1px solid #000;
                padding: 4px 5px;
                font-size: 14pt;
            }

            .rpt-table th {
                background-color: #f0f0f0;
                text-align: center;
                height: 35px;
            }

            .rpt-table td {
                height: 30px;
                vertical-align: middle;
            }

            .col-no {
                width: 50px;
                text-align: center;
            }

            .col-name {
                text-align: left;
            }

            .col-time {
                width: 80px;
                text-align: center;
            }

            .col-note {
                width: 120px;
                text-align: center;
            }

            /* Footer (Flexbox Layout) */
            .rpt-footer {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-top: 5px;
                font-size: 14pt;
                width: 100%;
            }

            .footer-left {
                text-align: left;
                white-space: nowrap;
            }

            .footer-right {
                text-align: left;
                white-space: nowrap;
            }

            .footer-row {
                margin-bottom: 5px;
            }

            /* Signature Area */
            .sign-area {
                width: 100%;
                text-align: center;
                margin-top: 40px;
            }

            .sign-text {
                margin-top: 5px;
                font-size: 14pt;
            }

            /* Print Mode */
            @media print {
                body {
                    background: white;
                    padding: 0;
                }

                .controls-bar {
                    display: none;
                }

                .paper {
                    box-shadow: none;
                    margin: 0;
                    width: 100%;
                    page-break-after: always;
                    padding: 15mm;
                }

                .paper:last-child {
                    page-break-after: auto;
                }
            }
        </style>

        <script src="supabase.js"></script>
        <script src="sweetalert2.js"></script>
        <script src="config.js"></script>
    </head>

    <body>

        <div class="controls-bar">
            <a href="menu.html" class="back-link"><i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π</a>
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
            <input type="date" id="filterDate" class="date-input">
            <button class="btn btn-load" onclick="generateReport()">
                <i class="fas fa-sync-alt"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
            <div style="flex-grow:1"></div>
            <button class="btn btn-print" onclick="window.print()">
                <i class="fas fa-print"></i> ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå / PDF
            </button>
        </div>

        <div id="reportContainer">
            <div class="paper">
                <div style="text-align:center; padding-top:100px; color:#999;">
                    <h3>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</h3>
                </div>
            </div>
        </div>

        <script>
            if (typeof sbClient === 'undefined') Swal.fire('Error', 'Connect Failed', 'error');

            let appSettings = {};

            document.addEventListener('DOMContentLoaded', async () => {
                document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];
                await loadSettings();
            });

            async function loadSettings() {
                try {
                    const { data } = await sbClient.from(TAS_CONFIG.TABLE_SETTINGS).select('*');
                    if (data) data.forEach(item => appSettings[item.key] = item.value);
                } catch (e) { console.error("Settings error", e); }
            }

            function formatThaiDate(dateStr) {
                const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
                const d = new Date(dateStr);
                const year = d.getFullYear() + 543;
                return `‡∏ß‡∏±‡∏ô${['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'][d.getDay()]}‡∏ó‡∏µ‡πà ${d.getDate()} ${months[d.getMonth()]} ‡∏û.‡∏®.${year}`;
            }

            function parseTime(t) { return t ? t.slice(0, 5) : ''; }

            function formatTypeName(typeName) {
                if (!typeName) return "";
                if (typeName.length > 25) {
                    const parts = typeName.split(' ');
                    if (parts.length > 1) { return parts[0] + "‡∏Ø"; }
                }
                return typeName;
            }

            async function generateReport() {
                const date = document.getElementById('filterDate').value;
                const container = document.getElementById('reportContainer');
                container.innerHTML = '<div class="paper" style="text-align:center; padding-top:100px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>';

                try {
                    const { data: users } = await sbClient.from(TAS_CONFIG.TABLE_USER).select('*').order('personnel_id');
                    const { data: att } = await sbClient.from(TAS_CONFIG.TABLE_TARGET).select('*').eq('work_date', date);
                    const { data: leaves } = await sbClient.from('Leave_records').select('*').eq('leave_date', date);

                    if (!users || users.length === 0) {
                        container.innerHTML = '<div class="paper" style="text-align:center; padding-top:100px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>';
                        return;
                    }

                    const attMap = {}; att?.forEach(x => attMap[x.personnel_id] = x);
                    const leaveMap = {}; leaves?.forEach(x => leaveMap[x.personnel_id] = x);

                    const groups = {};
                    users.forEach(u => {
                        const pType = u.personnel_type || u['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó';
                        if (!groups[pType]) groups[pType] = [];

                        const ts = attMap[u.personnel_id];
                        const lv = leaveMap[u.personnel_id];
                        let status = 'absent', note = '', tIn = '', tOut = '';

                        if (ts) {
                            status = 'present';
                            tIn = parseTime(ts.time_in); tOut = parseTime(ts.time_out);
                            const lateTime = appSettings['Late'] || '08:30';
                            const earlyTime = appSettings['early_leave'] || '16:30';
                            if (tIn > lateTime) note += '‡∏°‡∏≤‡∏™‡∏≤‡∏¢ ';
                            if (tOut && tOut < earlyTime) note += '‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô';
                            if (!tOut) note += '‡πÑ‡∏°‡πà‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö';
                        } else if (lv) {
                            status = 'leave';
                            note = lv.leave_type;
                            if (lv.leave_type.includes('‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£')) status = 'trip';
                        }
                        groups[pType].push({ ...u, tIn, tOut, status, note });
                    });

                    container.innerHTML = '';
                    Object.keys(groups).sort().forEach((type) => {
                        const list = groups[type];

                        // üî•üî• Logic ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà (Sort) üî•üî•
                        list.sort((a, b) => {
                            // Priority Group:
                            // 1. ‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (tIn) -> ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
                            // 2. ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (tOut) -> ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å
                            // 3. ‡∏•‡∏≤ (Leave/Trip) -> ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏≤
                            // 4. ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏Ç‡∏≤‡∏î) -> ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™

                            let groupA = 4, groupB = 4;

                            if (a.tIn) groupA = 1;
                            else if (a.tOut) groupA = 2;
                            else if (a.status === 'leave' || a.status === 'trip') groupA = 3;

                            if (b.tIn) groupB = 1;
                            else if (b.tOut) groupB = 2;
                            else if (b.status === 'leave' || b.status === 'trip') groupB = 3;

                            // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô
                            if (groupA !== groupB) return groupA - groupB;

                            // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°
                            if (groupA === 1) return a.tIn.localeCompare(b.tIn); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤
                            if (groupA === 2) return a.tOut.localeCompare(b.tOut); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å
                            if (groupA === 3) return a.note.localeCompare(b.note, 'th'); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏≤

                            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™
                            return a.personnel_id.localeCompare(b.personnel_id);
                        });

                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î
                        const total = list.length;
                        const present = list.filter(x => x.status === 'present').length;
                        const late = list.filter(x => x.note.includes('‡∏°‡∏≤‡∏™‡∏≤‡∏¢')).length;
                        const trip = list.filter(x => x.status === 'trip').length;
                        const absent_leave = list.filter(x => ['leave', 'absent'].includes(x.status)).length;
                        const vacant = 0; const borrowed = 0;
                        const shortTypeName = formatTypeName(type);

                        const pageDiv = document.createElement('div');
                        pageDiv.className = 'paper';

                        pageDiv.innerHTML = `
                        <div class="rpt-header">
                            <div class="rpt-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á${type}</div>
                            <div class="rpt-date">${formatThaiDate(date)}</div>
                            <div class="rpt-school">${appSettings['school_name'] || '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...'}</div>
                        </div>

                        <table class="rpt-table">
                            <thead>
                                <tr>
                                    <th class="col-no">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th class="col-name">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th class="col-time">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤</th>
                                    <th class="col-time">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö</th>
                                    <th class="col-note">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${list.map((u, idx) => `
                                    <tr>
                                        <td class="col-no">${idx + 1}</td>
                                        <td class="col-name">${u.name}</td>
                                        <td class="col-time" ${u.tIn > (appSettings['Late'] || '08:30') ? 'style="color:red"' : ''}>${u.tIn || ''}</td>
                                        <td class="col-time">${u.tOut || ''}</td>
                                        <td class="col-note" style="font-size:12pt;">${u.note || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div class="rpt-footer">
                            <div class="footer-left">
                                <div class="footer-row">${shortTypeName} ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${total} ‡∏Ñ‡∏ô</div>
                                <div class="footer-row">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ß‡πà‡∏≤‡∏á ${vacant > 0 ? vacant : '-'} ‡∏Ñ‡∏ô</div>
                                <div class="footer-row">‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ${trip > 0 ? trip : '-'} ‡∏Ñ‡∏ô</div>
                                <div class="footer-row">‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ${absent_leave > 0 ? absent_leave : '-'} ‡∏Ñ‡∏ô</div>
                            </div>
                            <div class="footer-right">
                                <div class="footer-row">‡∏°‡∏≤‡∏™‡∏≤‡∏¢ ${late > 0 ? late : '-'} ‡∏Ñ‡∏ô</div>
                                <div class="footer-row">‡∏¢‡∏∑‡∏°‡∏ï‡∏±‡∏ß‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ${borrowed > 0 ? borrowed : '-'} ‡∏Ñ‡∏ô</div>
                                <div class="footer-row">‡∏°‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ${present} ‡∏Ñ‡∏ô</div>
                                <div class="footer-row">&nbsp;</div>
                            </div>
                        </div>

                        <div class="sign-area">
                            <div class="sign-text" style="margin-bottom:20px;">(.......................................)</div>
                            <div class="sign-text" style="margin-bottom:5px;">(${appSettings['signer_name'] || '.......................................'})</div>
                            <div class="sign-text">${appSettings['signer_position'] || '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤...'}</div>
                        </div>
                        
                        <div style="position:absolute; bottom:15mm; right:15mm; font-size:10pt;">‡∏´‡∏ô‡πâ‡∏≤ 1</div>
                    `;
                        container.appendChild(pageDiv);
                    });

                } catch (err) {
                    container.innerHTML = `<div class="paper" style="color:red; text-align:center; padding-top:50px;">Error: ${err.message}</div>`;
                }
            }
        </script>
    </body>

</html>