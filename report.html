<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>รายงานประจำวัน - TAS-SPB</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TAS-SPB">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @font-face {
            font-family: 'THSarabunNew';
            src: url('font/THSarabunNew.ttf') format('truetype');
            font-weight: normal; font-style: normal;
        }
        @font-face {
            font-family: 'THSarabunNew';
            src: url('font/THSarabunNew Bold.ttf') format('truetype');
            font-weight: bold; font-style: normal;
        }

        :root { 
            --paper-w: 210mm; --paper-h: 297mm;
            --pad-top: 20mm; --pad-bottom: 20mm; --pad-left: 30mm; --pad-right: 20mm;
            --content-w: calc(var(--paper-w) - var(--pad-left) - var(--pad-right));
            --half-w: calc(var(--content-w) / 2);
            --col-back-line: calc(var(--half-w) + 75px);
        }
        
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        
        body { 
            font-family: 'THSarabunNew', sans-serif; 
            background: #525659; margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
        }

        .toolbar { 
            width: 100%; position: sticky; top: 0; z-index: 100; 
            background: white; padding: 12px; border-bottom: 1px solid #ddd; 
            display: flex; justify-content: center; align-items: center; gap: 8px; 
        }
        .btn { 
            padding: 10px 18px; border-radius: 10px; border: none; cursor: pointer; 
            font-weight: bold; font-family: 'THSarabunNew'; font-size: 15pt;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            min-width: 110px; line-height: 1;
        }
        .btn-load { background: #4f46e5; color: white; }
        .btn-print { background: #1e293b; color: white; }
        .date-input { padding: 8px 12px; border-radius: 10px; border: 1px solid #cbd5e1; font-family: 'THSarabunNew'; font-size: 15pt; height: 42px; }

        #reportWrapper { padding: 20px 0; display: flex; flex-direction: column; align-items: center; width: 100%; }
        
        .paper { 
            width: var(--paper-w); height: var(--paper-h); background: white; 
            padding: var(--pad-top) var(--pad-right) var(--pad-bottom) var(--pad-left);
            margin-bottom: 10mm; position: relative; display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        @media screen and (max-width: 215mm) {
            #reportWrapper { transform: scale(0.42); transform-origin: top center; height: auto; margin-bottom: -60%; }
        }

        /* หัวเรื่อง: แก้ไข Logic การตัดคำให้เป็นธรรมชาติ */
        .rpt-header { text-align: center; margin-bottom: 6mm; line-height: 1.1; }
        .rpt-title { 
            font-size: 18pt; 
            font-weight: bold; 
            display: block; 
            width: 100%;
            white-space: normal; /* ปล่อยให้ไหลตามธรรมชาติ */
            word-break: keep-all; /* ไม่ตัดกลางคำไทย ให้ตัดที่วรรคเท่านั้น */
            overflow-wrap: break-word;
        }
        .rpt-sub { font-size: 18pt; }

        /* ตารางปรับความสูงแถว 26.4px เพื่อความแม่นยำ 29 รายการ */
        .rpt-table { width: 100%; border-collapse: collapse; border: 1.5px solid black; table-layout: fixed; }
        .rpt-table th { border: 1px solid black; background: #f2f2f2; font-weight: bold; height: 35px; font-size: 16pt; text-align: center; }
        .rpt-table td { 
            border: 1px solid black; padding: 0 5px; font-size: 16pt; 
            height: 26.4px; 
            vertical-align: middle; line-height: 1.0; 
            overflow: hidden; white-space: nowrap; text-overflow: ellipsis; 
        }

        .col-id { width: 45px; text-align: center; }
        .col-name { width: calc(var(--half-w) - 45px); }
        .col-time { width: 75px; text-align: center; }

        .footer-content { margin-top: 3.5mm; width: 100%; font-size: 16pt; }
        .summary-grid { display: grid; grid-template-columns: var(--col-back-line) 1fr; line-height: 1.3; }
        .summary-left { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; padding-right: 10px; }

        .signature-area { width: 100%; text-align: center; margin-top: 10mm; line-height: 1.5; font-size: 16pt; }
        .page-num { position: absolute; bottom: 8mm; right: 20mm; font-size: 14pt; color: #333; }

        @media print {
            body { background: none; } .toolbar { display: none; }
            #reportWrapper { transform: none !important; margin: 0; padding: 0; }
            .paper { margin: 0; box-shadow: none; page-break-after: always; }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button class="btn" style="background:#f1f5f9; color:#475569;" onclick="window.location.href='menu.html'"><i class="fas fa-arrow-left"></i> เมนู</button>
        <input type="date" id="reportDate" class="date-input">
        <button class="btn btn-load" onclick="loadData()"><i class="fas fa-sync-alt"></i> โหลดข้อมูล</button>
        <button class="btn btn-print" onclick="window.print()"><i class="fas fa-file-pdf"></i> พิมพ์ / PDF</button>
    </div>

    <div id="reportWrapper"></div>

    <script src="ios-fix.js"></script>
    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>

    <script>
        const ROWS_PER_PAGE = 29;

        function truncateTypeFooter(name) {
            return name.length > 35 ? name.substring(0, 35) + "ฯ" : name;
        }

        async function loadData() {
            const dateStr = document.getElementById('reportDate').value;
            const wrapper = document.getElementById('reportWrapper');
            if(!dateStr) return;
            wrapper.innerHTML = '<div class="paper"><div style="text-align:center; margin-top:100mm; font-size:18pt;">กำลังโหลด...</div></div>';

            try {
                const { data: users } = await sbClient.from(TAS_CONFIG.TABLE_USER).select('*');
                const { data: att } = await sbClient.from(TAS_CONFIG.TABLE_TARGET).select('*').eq('work_date', dateStr);
                const { data: leaves } = await sbClient.from('Leave_records').select('*').eq('leave_date', dateStr);
                const { data: settings } = await sbClient.from(TAS_CONFIG.TABLE_SETTINGS).select('*');
                
                const config = {}; 
                if(settings) settings.forEach(s => config[s.key] = s.value);
                const attMap = {}; 
                if(att) att.forEach(a => attMap[a.personnel_id] = a);
                const leaveMap = {}; 
                if(leaves) leaves.forEach(l => leaveMap[l.personnel_id] = l);

                const groups = {};
                if(users) {
                    users.forEach(u => {
                        const type = u.personnel_type || 'ทั่วไป';
                        if(!groups[type]) groups[type] = [];
                        const ts = attMap[u.personnel_id];
                        const lv = leaveMap[u.personnel_id];
                        u.tIn = ts?.time_in || "";
                        u.tOut = ts?.time_out || "";
                        u.note = lv?.leave_type || (u.tIn > (config['Late'] || '08:30') ? "มาสาย" : "");
                        u.sortKey = u.tIn ? `1_${u.tIn}` : `2_${u.note}`;
                        groups[type].push(u);
                    });
                }

                const sortedGroups = Object.keys(groups).sort();
                wrapper.innerHTML = "";
                
                sortedGroups.forEach(type => {
                    const sortedList = groups[type].sort((a,b) => a.sortKey.localeCompare(b.sortKey));
                    const totalPages = Math.ceil(sortedList.length / ROWS_PER_PAGE);

                    for(let p = 0; p < totalPages; p++) {
                        const pageEl = document.createElement('div');
                        pageEl.className = 'paper';
                        const items = sortedList.slice(p * ROWS_PER_PAGE, (p + 1) * ROWS_PER_PAGE);
                        
                        // หัวเรื่อง: ใช้ช่องว่างปกติเพื่อให้ Browser คำนวณจุดตัดบรรทัดเองที่วรรค
                        const headerTitle = "บันทึกการลงเวลาปฏิบัติงานของ " + type;

                        pageEl.innerHTML = `
                            <div class="rpt-header">
                                <div class="rpt-title">${headerTitle}</div>
                                <div class="rpt-sub">${formatThaiDate(dateStr)}</div>
                                <div class="rpt-sub">${config['school_name'] || ''}</div>
                            </div>
                            <table class="rpt-table">
                                <thead>
                                    <tr><th class="col-id">ที่</th><th class="col-name">ชื่อ-สกุล</th><th class="col-time">ลงเวลามา</th><th class="col-time">ลงเวลากลับ</th><th style="width:auto;">หมายเหตุ</th></tr>
                                </thead>
                                <tbody>
                                    ${items.map((u, i) => `
                                        <tr>
                                            <td class="col-id">${(p*ROWS_PER_PAGE)+i+1}</td>
                                            <td class="col-name">${u.name}</td>
                                            <td class="col-time">${u.tIn ? u.tIn.slice(0,5) : ''}</td>
                                            <td class="col-time">${u.tOut ? u.tOut.slice(0,5) : ''}</td>
                                            <td>${u.note}</td>
                                        </tr>`).join('')}
                                </tbody>
                            </table>
                            <div class="page-num">${p+1}/${totalPages}</div>
                        `;

                        if(p === totalPages - 1) {
                            const tripCount = sortedList.filter(x => x.note.includes('ราชการ')).length;
                            const leaveCount = sortedList.filter(x => x.note && !x.note.includes('ราชการ') && !x.note.includes('สาย')).length;
                            const lateCount = sortedList.filter(x => x.note === 'มาสาย').length;
                            const displayType = truncateTypeFooter(type);

                            const footer = document.createElement('div');
                            footer.className = 'footer-content';
                            footer.innerHTML = `
                                <div class="summary-grid">
                                    <div class="summary-left">
                                        ${displayType} ทั้งหมด ${sortedList.length} คน<br>
                                        ตำแหน่งว่าง ${getVal(config['vacant_position'], type)} คน<br>
                                        ไปราชการ ${tripCount || '-'}<br>
                                        ไม่มาปฏิบัติราชการ ${leaveCount || '-'} คน
                                    </div>
                                    <div>
                                        มาสาย ${lateCount || '-'} คน<br>
                                        ยืมตัวมาช่วยราชการ ${getVal(config['government_service'], type)} คน<br>
                                        มาปฏิบัติราชการ ${sortedList.length - leaveCount} คน
                                    </div>
                                </div>
                                <div class="signature-area">
                                    <div style="margin-top:5mm;">(ลงชื่อ)............................................................</div>
                                    <div style="margin-top:2mm;">(${config['signer_name'] || ''})</div>
                                    <div>${config['signer_position'] || ''}</div>
                                </div>
                            `;
                            pageEl.appendChild(footer);
                        }
                        wrapper.appendChild(pageEl);
                    }
                });
            } catch (e) { console.error(e); }
        }

        function getVal(str, type) {
            if(!str) return "-";
            const pair = str.split(',').find(p => p.trim().startsWith(type+":"));
            const v = pair?.split(':')[1]; 
            return (v && v.trim() !== "0") ? v.trim() : "-";
        }

        function formatThaiDate(d) {
            const date = new Date(d);
            const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            return `วัน${['อาทิตย์','จันทร์','อังคาร','พุธ','พฤหัสบดี','ศุกร์','เสาร์'][date.getDay()]}ที่ ${date.getDate()} ${months[date.getMonth()]} พ.ศ. ${date.getFullYear()+543}`;
        }

        document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>
