<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå - TAS-SPB</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="ios-fix.js"></script>
    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>

    <style>
        :root { --primary: #4f46e5; --bg: #f3f4f6; --white: #ffffff; --text: #1f2937; --muted: #6b7280; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); color: var(--text); padding: 15px; padding-bottom: 50px; }
        .container { max-width: 500px; margin: 0 auto; }
        
        .card { background: var(--white); border-radius: 24px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .profile-info { text-align: center; margin-bottom: 15px; }
        .user-emoji { font-size: 4rem; display: block; margin-bottom: 10px; }
        .user-name { font-size: 1.4rem; font-weight: 700; color: var(--text); }
        .user-id { color: var(--muted); font-size: 0.9rem; margin-top: 4px; }

        .section-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px; }
        .section-title h3 { font-size: 1.1rem; font-weight: 700; }
        
        .history-item { 
            background: var(--white); border-radius: 16px; padding: 15px; margin-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: center;
            border-left: 5px solid transparent; transition: 0.2s;
        }
        .item-db { border-left-color: #10b981; } 
        .item-url { border-left-color: #3b82f6; } 
        .item-leave { border-left-color: #f59e0b; } 

        .item-date { font-weight: 700; font-size: 1rem; }
        .item-source { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; }
        .time-badge { padding: 4px 8px; border-radius: 8px; font-weight: 700; font-size: 0.9rem; }
        .t-in { background: #dcfce7; color: #15803d; }
        .t-out { background: #fee2e2; color: #b91c1c; }

        .pagination { display: flex; gap: 10px; justify-content: center; margin: 20px 0; }
        .btn-page { 
            padding: 10px 20px; border: none; border-radius: 12px; background: var(--white); 
            color: var(--primary); font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn-page:disabled { color: #d1d5db; cursor: not-allowed; }

        .btn-action { width: 100%; padding: 16px; border: none; border-radius: 16px; background: var(--primary); color: white; font-weight: 700; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-back { display: block; text-align: center; padding: 15px; color: var(--muted); text-decoration: none; font-weight: 600; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="profile-info">
                <span class="user-emoji">üë§</span>
                <div class="user-name" id="u-name">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                <div class="user-id" id="u-id">‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£: -</div>
            </div>
            <button class="btn-action" onclick="changePassword()">üîê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
        </div>

        <div class="section-title">
            <h3>üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h3>
            <span id="att-page-info" style="font-size: 0.8rem; color: var(--muted);"></span>
        </div>
        <div id="att-list"></div>
        <div class="pagination">
            <button id="att-prev" class="btn-page" onclick="changeAttPage(-1)">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
            <button id="att-next" class="btn-page" onclick="changeAttPage(1)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>

        <div class="section-title">
            <h3>‚úàÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h3>
            <span id="leave-page-info" style="font-size: 0.8rem; color: var(--muted);"></span>
        </div>
        <div id="leave-list"></div>
        <div class="pagination">
            <button id="leave-prev" class="btn-page" onclick="changeLeavePage(-1)">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
            <button id="leave-next" class="btn-page" onclick="changeLeavePage(1)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>

        <a href="menu.html" class="btn-back"><i class="fas fa-chevron-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π</a>
    </div>

    <script>
        const user = JSON.parse(localStorage.getItem('tas_user') || '{}');
        let attPage = 0, leavePage = 0;
        const pageSize = 7; 
        let externalBaseURL = "";

        document.addEventListener('DOMContentLoaded', async () => {
            if (!user.personnel_id) { window.location.href = 'login.html'; return; }
            document.getElementById('u-name').innerText = user.name;
            document.getElementById('u-id').innerText = `‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£: ${user.personnel_id}`;
            
            await fetchSettings();
            loadAttendance();
            loadLeaves();
        });

        async function fetchSettings() {
            try {
                const { data } = await sbClient.from(TAS_CONFIG.TABLE_SETTINGS).select('value').eq('key', 'data_url').single();
                if (data) externalBaseURL = data.value;
            } catch (e) { console.error("Setting error", e); }
        }

        async function loadAttendance() {
            const container = document.getElementById('att-list');
            container.innerHTML = '<p style="text-align:center; padding:20px; color:#9ca3af;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤...</p>';
            
            try {
                // 1. ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Database (TimeStamp)
                const { data: dbData } = await sbClient.from(TAS_CONFIG.TABLE_TARGET)
                    .select('work_date, time_in, time_out')
                    .eq('personnel_id', user.personnel_id)
                    .order('work_date', { ascending: false })
                    .range(attPage * pageSize, (attPage + 1) * pageSize - 1);

                let combinedHTML = "";
                const dbDates = new Set();

                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å DB
                if (dbData && dbData.length > 0) {
                    dbData.forEach(item => {
                        dbDates.add(item.work_date);
                        combinedHTML += renderHistoryItem(item, 'DB');
                    });
                }

                // 2. ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å URL ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å (‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ/ ‡πÄ‡∏ä‡πà‡∏ô 30122025/)
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                if (externalBaseURL) {
                    const today = new Date();
                    for(let i=0; i<pageSize; i++) {
                        const targetDate = new Date();
                        targetDate.setDate(today.getDate() - (attPage * pageSize + i));
                        const dateDB = targetDate.toISOString().split('T')[0];
                        
                        // ‡∏Å‡∏£‡∏≠‡∏á: ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÉ‡∏ô DB ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å URL (‡πÅ‡∏ï‡πà‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ô)
                        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå "‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡πÉ‡∏ô TimeStamp ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏ô url"
                        // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏™‡πà‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ dbDates
                        
                        if (!dbDates.has(dateDB)) {
                            const dateURL = formatDateForURL(targetDate);
                            const fullURL = externalBaseURL.endsWith('/') ? externalBaseURL + dateURL + '/' : externalBaseURL + '/' + dateURL + '/';
                            
                            // ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ fetch(fullURL) ‡∏ú‡πà‡∏≤‡∏ô Proxy (AllOrigins)
                            // ‡πÉ‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤
                            combinedHTML += renderHistoryItem({ work_date: dateDB, time_in: '‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å', time_out: 'URL' }, 'URL');
                        }
                    }
                }
                
                container.innerHTML = combinedHTML || '<p style="text-align:center; padding:20px; color:#9ca3af;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</p>';
                document.getElementById('att-page-info').innerText = `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà ${attPage + 1}`;
                document.getElementById('att-prev').disabled = attPage === 0;
            } catch (e) { container.innerHTML = 'Error loading attendance.'; }
        }

        function renderHistoryItem(item, source) {
            const sourceText = source === 'DB' ? '‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö (DB)' : '‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å (URL)';
            const cssClass = source === 'DB' ? 'item-db' : 'item-url';
            return `
                <div class="history-item ${cssClass}">
                    <div>
                        <div class="item-date">${formatThaiDate(item.work_date)}</div>
                        <div class="item-source">${sourceText}</div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <span class="time-badge t-in">${item.time_in ? item.time_in.slice(0, 5) : '--:--'}</span>
                        <span class="time-badge t-out">${item.time_out ? item.time_out.slice(0, 5) : '--:--'}</span>
                    </div>
                </div>`;
        }

        function formatDateForURL(date) {
            const d = String(date.getDate()).padStart(2, '0');
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const y = date.getFullYear();
            return `${d}${m}${y}`; // ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå 30122025
        }

        async function loadLeaves() {
            const container = document.getElementById('leave-list');
            container.innerHTML = '<p style="text-align:center; padding:20px; color:#9ca3af;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤...</p>';

            try {
                const { data } = await sbClient.from('Leave_records')
                    .select('*')
                    .eq('personnel_id', user.personnel_id)
                    .order('leave_date', { ascending: false })
                    .range(leavePage * pageSize, (leavePage + 1) * pageSize - 1);

                if (data && data.length > 0) {
                    container.innerHTML = data.map(item => `
                        <div class="history-item item-leave">
                            <div>
                                <div class="item-date">${formatThaiDate(item.leave_date)}</div>
                                <div class="item-source">${item.leave_type}</div>
                            </div>
                            <div style="font-size:0.8rem; color:var(--muted);">${item.status || '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="text-align:center; padding:20px; color:#9ca3af;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</p>';
                }
                document.getElementById('leave-page-info').innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${leavePage + 1}`;
                document.getElementById('leave-prev').disabled = leavePage === 0;
            } catch (e) { container.innerHTML = 'Error loading leaves.'; }
        }

        function changeAttPage(step) { attPage += step; loadAttendance(); window.scrollTo(0,0); }
        function changeLeavePage(step) { leavePage += step; loadLeaves(); }

        function formatThaiDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
        }

        async function changePassword() {
            const { value: newPass } = await Swal.fire({
                title: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
                input: 'password',
                inputPlaceholder: '‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                inputAttributes: { minlength: 4 },
                inputValidator: (v) => { if (!v) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'; }
            });

            if (newPass) {
                const { error } = await sbClient.from(TAS_CONFIG.TABLE_USER).update({ Password: newPass }).eq('personnel_id', user.personnel_id);
                if (!error) {
                    user.Password = newPass;
                    localStorage.setItem('tas_user', JSON.stringify(user));
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                }
            }
        }
    </script>
</body>
</html>
