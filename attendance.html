<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ TAS-SPB</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>

    <style>
        :root {
            --primary: #ec4899; --bg: #f3f4f6; --text: #1f2937;
            --muted: #6b7280; --border: #e5e7eb; --success: #10b981; --danger: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); color: var(--text); padding: 10px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .container { max-width: 800px; margin: 0 auto; width: 100%; flex: 1; display: flex; flex-direction: column; }

        /* Header & Main Tabs */
        .card-header { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 10px; border-bottom: 4px solid var(--primary); }
        .tabs { display: flex; background: #fdf2f8; padding: 5px; border-radius: 15px; margin-bottom: 10px; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; border-radius: 10px; cursor: pointer; font-weight: 700; color: var(--muted); font-size: 0.9rem; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* Sub Filter UI */
        .sub-filter-area { margin-bottom: 10px; flex-shrink: 0; }
        .sub-tabs { display: flex; gap: 5px; background: #fff; padding: 5px; border-radius: 12px; border: 1px solid var(--border); }
        .sub-btn { flex: 1; padding: 8px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-size: 0.8rem; font-weight: bold; color: var(--muted); }
        .sub-btn.active { background: var(--primary); color: white; }

        /* List Styling */
        .content-scroll { flex: 1; overflow-y: auto; display: flex; flex-direction: column; padding-bottom: 80px; }
        .data-list { display: grid; gap: 8px; align-content: start; }
        .data-item { 
            background: white; padding: 12px; border-radius: 15px; border-left: 5px solid #ccc; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); min-height: 85px; 
        }
        .item-att { border-left-color: var(--primary); }
        .item-leave { border-left-color: #f59e0b; }
        .item-person { border-left-color: #6b7280; }

        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        
        .date-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 12px; font-family: 'Sarabun'; margin-bottom: 8px; font-size: 0.9rem; }
        
        /* Pager UI */
        .pager { display: flex; justify-content: center; align-items: center; gap: 15px; padding: 10px 0; flex-shrink: 0; }
        .btn-page { width: 35px; height: 35px; border-radius: 10px; border: 1px solid var(--border); background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-page:disabled { opacity: 0.3; }
        
        .actions { display: flex; gap: 5px; }
        .btn-icon { width: 32px; height: 32px; border-radius: 8px; border: none; background: #f3f4f6; color: var(--muted); cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* FAB ‡∏õ‡∏∏‡πà‡∏° (+) ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á */
        .fab { 
            position: fixed; bottom: 30px; right: 25px; 
            width: 60px; height: 60px; 
            background: linear-gradient(135deg, #ec4899, #be185d); 
            color: white; border-radius: 50%; border: none; 
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer; z-index: 1000;
            box-shadow: 0 8px 15px rgba(236, 72, 153, 0.4);
            transition: 0.3s;
        }
        .fab:hover { transform: scale(1.1); }
    </style>
</head>
<body>

<div class="container" id="app-container" style="display: none;">
    <div class="card-header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="font-size:1.1rem;"><i class="fas fa-user-cog"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ TAS-SPB</h2>
            <a href="menu.html" style="color:var(--primary);"><i class="fas fa-home fa-lg"></i></a>
        </div>
    </div>

    <div class="tabs" id="main-tabs"></div>

    <div class="content-scroll" id="main-content">
        <div id="section-att" class="content-section" style="display:none;">
            <div class="sub-filter-area">
                <input type="date" id="attDate" class="date-input" onchange="resetAndRender()">
                <div class="sub-tabs">
                    <button class="sub-btn active" id="att-sub-comp" onclick="setAttSub('comp')">‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</button>
                    <button class="sub-btn" id="att-sub-inc" onclick="setAttSub('inc')">‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</button>
                </div>
            </div>
            <div id="list-att" class="data-list"></div>
        </div>

        <div id="section-leave" class="content-section" style="display:none;">
            <div class="sub-filter-area">
                <div class="sub-tabs">
                    <button class="sub-btn active" id="leave-sub-all" onclick="setLeaveSub('all')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</button>
                    <button class="sub-btn" id="leave-sub-date" onclick="setLeaveSub('date')">‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô</button>
                </div>
                <div id="leave-date-input-area" style="display:none; margin-top:10px;">
                    <input type="date" id="leaveDate" class="date-input" onchange="resetAndRender()">
                </div>
            </div>
            <div id="list-leave" class="data-list"></div>
        </div>

        <div id="section-person" class="content-section" style="display:none;">
            <div id="list-person" class="data-list"></div>
        </div>
    </div>

    <div class="pager">
        <button class="btn-page" id="prevBtn" onclick="movePage(-1)"><i class="fas fa-chevron-left"></i></button>
        <span id="pageInfo" style="font-weight:bold; font-size:0.8rem; color:var(--muted);">‡∏´‡∏ô‡πâ‡∏≤ 1 / 1</span>
        <button class="btn-page" id="nextBtn" onclick="movePage(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<button class="fab" id="fab-add" style="display: none;" onclick="handleAdd()">
    <i class="fas fa-plus"></i>
</button>

<script>
    let userData = {};
    let currentTab = '';
    let filters = { att: 'comp', leave: 'all' };
    let pages = { att: 1, leave: 1, person: 1 };
    let personnelList = [];
    let personnelMap = {};
    let totalItems = 0;
    let leaveTypes = [];

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢ ‡∏ß‡∏ß/‡∏î‡∏î/‡∏õ‡∏õ‡∏õ‡∏õ (‡∏û.‡∏®.)
    function fmtThai(d) {
        if(!d) return '-';
        const date = new Date(d);
        return date.toLocaleDateString('th-TH', {day:'2-digit', month:'2-digit', year:'numeric'});
    }

    const checkAccess = () => {
        userData = JSON.parse(localStorage.getItem('tas_user') || '{}');
        const level = String(userData.level || '');
        if (level !== '1' && level !== '2') { window.location.replace('menu.html'); return false; }

        const tabsHtml = [];
        if (level === '1') tabsHtml.push('<button id="tab-att-btn" class="tab-btn" onclick="changeMainTab(\'att\')">üïí ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>');
        tabsHtml.push('<button id="tab-leave-btn" class="tab-btn" onclick="changeMainTab(\'leave\')">‚úàÔ∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏≤</button>');
        tabsHtml.push('<button id="tab-person-btn" class="tab-btn" onclick="changeMainTab(\'person\')">üë• ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>');
        
        document.getElementById('main-tabs').innerHTML = tabsHtml.join('');
        document.getElementById('app-container').style.display = 'flex';
        document.getElementById('fab-add').style.display = 'flex';
        changeMainTab(level === '1' ? 'att' : 'leave');
        return true;
    };

    function getPageSize() {
        const contentH = document.getElementById('main-content').clientHeight;
        const activeFilterH = document.querySelector(`#section-${currentTab} .sub-filter-area`)?.clientHeight || 0;
        return Math.floor((contentH - activeFilterH - 20) / 95) || 4;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        if (!checkAccess()) return;
        const today = new Date().toISOString().split('T')[0];
        if(document.getElementById('attDate')) document.getElementById('attDate').value = today;
        document.getElementById('leaveDate').value = today;
        await loadMasterData();
        render();
        window.addEventListener('resize', render);
    });

    async function loadMasterData() {
        const { data: pData } = await sbClient.from('Personnel').select('*').order('name');
        personnelList = pData || [];
        personnelList.forEach(p => personnelMap[p.personnel_id] = p.name);
        const { data: sData } = await sbClient.from('Settings').select('value').eq('key', 'leave_types').single();
        leaveTypes = sData?.value ? sData.value.split(',').map(t => t.trim()) : ['‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', '‡∏•‡∏≤‡∏Å‡∏¥‡∏à', '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô'];
    }

    function changeMainTab(t) {
        currentTab = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === `tab-${t}-btn`));
        document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
        document.getElementById(`section-${t}`).style.display = 'block';
        resetAndRender();
    }

    function setAttSub(s) { filters.att = s; document.getElementById('att-sub-comp').classList.toggle('active', s === 'comp'); document.getElementById('att-sub-inc').classList.toggle('active', s === 'inc'); resetAndRender(); }
    function setLeaveSub(s) { filters.leave = s; document.getElementById('leave-sub-all').classList.toggle('active', s === 'all'); document.getElementById('leave-sub-date').classList.toggle('active', s === 'date'); document.getElementById('leave-date-input-area').style.display = s === 'date' ? 'block' : 'none'; resetAndRender(); }
    function resetAndRender() { pages[currentTab] = 1; render(); }
    function movePage(step) { pages[currentTab] += step; render(); }

    async function render() {
        const size = getPageSize();
        const from = (pages[currentTab] - 1) * size, to = from + size - 1;
        if(currentTab === 'att') await renderAtt(from, to);
        else if(currentTab === 'leave') await renderLeave(from, to);
        else await renderPerson(from, to);
        const maxP = Math.ceil(totalItems / size) || 1;
        document.getElementById('pageInfo').innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${pages[currentTab]} / ${maxP}`;
        document.getElementById('prevBtn').disabled = pages[currentTab] === 1;
        document.getElementById('nextBtn').disabled = pages[currentTab] >= maxP;
    }

    async function renderAtt(f, t) {
        const date = document.getElementById('attDate').value;
        let q = sbClient.from('TimeStamp').select('*', {count:'exact'}).eq('work_date', date);
        if(filters.att === 'comp') q = q.not('time_in', 'is', null).not('time_out', 'is', null);
        else q = q.or('time_in.is.null,time_out.is.null');
        const { data, count } = await q.order('time_in', {ascending:true}).range(f, t);
        totalItems = count || 0;
        document.getElementById('list-att').innerHTML = data?.map(r => `
            <div class="data-item item-att">
                <div style="flex:1">
                    <strong>${personnelMap[r.personnel_id] || r.full_name}</strong><br>
                    <small>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${fmtThai(r.work_date)}</small>
                    <div style="margin-top:4px;">
                        <span class="badge ${r.time_in?'bg-green':'bg-red'}">IN: ${r.time_in?.slice(0,5)||'--:--'}</span>
                        <span class="badge ${r.time_out?'bg-green':'bg-red'}">OUT: ${r.time_out?.slice(0,5)||'--:--'}</span>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn-icon" onclick="editAtt('${r.id}','${r.time_in}','${r.time_out}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-icon" onclick="delRec('TimeStamp','${r.id}')"><i class="fas fa-trash text-danger"></i></button>
                </div>
            </div>`).join('') || '<center>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>';
    }

    async function renderLeave(f, t) {
        let q = sbClient.from('Leave_records').select('*', {count:'exact'});
        if(filters.leave === 'date') q = q.eq('leave_date', document.getElementById('leaveDate').value);
        const { data, count } = await q.order('leave_date', {ascending:false}).range(f, t);
        totalItems = count || 0;
        document.getElementById('list-leave').innerHTML = data?.map(r => `
            <div class="data-item item-leave">
                <div style="flex:1">
                    <small style="color:var(--primary); font-weight:bold;">üìÖ ${fmtThai(r.leave_date)}</small><br>
                    <strong>${personnelMap[r.personnel_id] || r.personnel_id}</strong><br>
                    <span class="badge" style="background:#fff7ed; color:#c2410c;">${r.leave_type}</span>
                </div>
                <div class="actions">
                    <button class="btn-icon" onclick="editLeave('${r.id}','${r.leave_date}','${r.leave_type}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-icon" onclick="delRec('Leave_records','${r.id}')"><i class="fas fa-trash text-danger"></i></button>
                </div>
            </div>`).join('') || '<center>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>';
    }

    async function renderPerson(f, t) {
        const { data, count } = await sbClient.from('Personnel').select('*', {count:'exact'}).order('personnel_id').range(f, t);
        totalItems = count || 0;
        const canEdit = userData.level == 1;
        document.getElementById('list-person').innerHTML = data?.map(p => `
            <div class="data-item item-person">
                <div style="flex:1">
                    <strong>${p.name}</strong><br>
                    <small>‡∏£‡∏´‡∏±‡∏™: ${p.personnel_id}</small><br>
                    <small>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô: ${fmtThai(p.start_date)}</small>
                </div>
                <div class="actions" style="${canEdit ? '' : 'display:none'}">
                    <button class="btn-icon" onclick="editPerson('${p.personnel_id}','${p.name}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-icon" onclick="delRec('Personnel','${p.personnel_id}','personnel_id')"><i class="fas fa-trash text-danger"></i></button>
                </div>
            </div>`).join('') || '<center>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</center>';
    }

    async function delRec(tbl, id, col='id') { if((await Swal.fire({title:'‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?', icon:'warning', showCancelButton:true, confirmButtonColor:'#ef4444'})).isConfirmed) { await sbClient.from(tbl).delete().eq(col, id); render(); } }
    
    async function editAtt(id, tin, tout) { const { value: f } = await Swal.fire({ title:'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤', html:`‡πÄ‡∏Ç‡πâ‡∏≤: <input id="sw-in" type="time" class="swal2-input" value="${tin?.slice(0,5)||''}"> ‡∏≠‡∏≠‡∏Å: <input id="sw-out" type="time" class="swal2-input" value="${tout?.slice(0,5)||''}">`, preConfirm:()=>({ time_in: document.getElementById('sw-in').value || null, time_out: document.getElementById('sw-out').value || null }) }); if(f) { await sbClient.from('TimeStamp').update(f).eq('id', id); render(); } }
    
    async function editLeave(id, date, type) { const { value: f } = await Swal.fire({ title:'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏•‡∏≤', html:`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <input id="sw-date" type="date" class="swal2-input" value="${date}"> ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: <select id="sw-type" class="swal2-input">${leaveTypes.map(t => `<option value="${t}" ${t===type?'selected':''}>${t}</option>`).join('')}</select>`, preConfirm:()=>({ leave_date: document.getElementById('sw-date').value, leave_type: document.getElementById('sw-type').value }) }); if(f) { await sbClient.from('Leave_records').update(f).eq('id', id); render(); } }
    
    async function editPerson(id, name) { const { value: n } = await Swal.fire({ title:'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠', input:'text', inputValue:name }); if(n) { await sbClient.from('Personnel').update({name:n}).eq('personnel_id', id); await loadMasterData(); render(); } }

    async function handleAdd() {
        if (currentTab === 'person') {
            const { value: f } = await Swal.fire({ 
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£', 
                html: `<input id="sw-pid" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£" class="swal2-input"><input id="sw-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="swal2-input"><div style="text-align:left; padding:0 20px;"><small>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô:</small></div><input id="sw-start" type="date" class="swal2-input" value="${new Date().toISOString().split('T')[0]}">`, 
                preConfirm: () => ({ personnel_id: document.getElementById('sw-pid').value, name: document.getElementById('sw-name').value, start_date: document.getElementById('sw-start').value, level: 3 }) 
            });
            if (f?.personnel_id) { await sbClient.from('Personnel').insert([f]); await loadMasterData(); render(); }
        } else if (currentTab === 'leave') {
            let selectedDate = new Date().toISOString().split('T')[0];
            const getAbsentList = async (targetDate) => {
                const { data: allP } = await sbClient.from('Personnel').select('personnel_id, name');
                const { data: att } = await sbClient.from('TimeStamp').select('personnel_id').eq('work_date', targetDate);
                const { data: lve } = await sbClient.from('Leave_records').select('personnel_id').eq('leave_date', targetDate);
                const busy = new Set([...(att || []).map(x => x.personnel_id), ...(lve || []).map(x => x.personnel_id)]);
                return (allP || []).filter(p => !busy.has(p.personnel_id));
            };
            const absentList = await getAbsentList(selectedDate);
            const { value: f } = await Swal.fire({
                title: '<span style="color:#ec4899; font-weight:bold;">‚úàÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà</span>',
                html: `<div style="text-align:left; padding: 5px;"><div style="margin-bottom:12px;"><label style="font-weight:bold; font-size:0.8rem; color:#6b7280;">‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤</label><input type="date" id="sw-date" class="swal2-input" style="border-radius:12px;" value="${selectedDate}"></div><div style="margin-bottom:12px;"><label style="font-weight:bold; font-size:0.8rem; color:#6b7280;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤/‡πÑ‡∏°‡πà‡∏•‡∏≤)</label><select id="sw-pid" class="swal2-input" style="border-radius:12px;">${absentList.map(p => `<option value="${p.personnel_id}">${p.name}</option>`).join('') || '<option value="">-- ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß --</option>'}</select></div><div><label style="font-weight:bold; font-size:0.8rem; color:#6b7280;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label><select id="sw-type" class="swal2-input" style="border-radius:12px;">${leaveTypes.map(t => `<option value="${t}">${t}</option>`)}</select></div></div>`,
                background: '#fef2f8', confirmButtonColor: '#ec4899', showCancelButton: true, reverseButtons: true,
                didOpen: () => {
                    const dIn = document.getElementById('sw-date'), pSel = document.getElementById('sw-pid');
                    dIn.addEventListener('change', async () => {
                        pSel.innerHTML = '<option>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>';
                        const newList = await getAbsentList(dIn.value);
                        pSel.innerHTML = newList.map(p => `<option value="${p.personnel_id}">${p.name}</option>`).join('') || '<option value="">-- ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß --</option>';
                    });
                },
                preConfirm: () => {
                    const pid = document.getElementById('sw-pid').value;
                    if (!pid) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return false; }
                    return { id: Date.now().toString(), personnel_id: pid, leave_date: document.getElementById('sw-date').value, leave_type: document.getElementById('sw-type').value, status: 'approved' };
                }
            });
            if (f?.personnel_id) { await sbClient.from('Leave_records').insert([f]); render(); }
        } else if (currentTab === 'att') {
            let mode = 'in'; 
            const { value: f } = await Swal.fire({
                title: '<span style="color:#ec4899; font-weight:bold;">üïí ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠</span>',
                html: `
                    <div style="text-align:left; padding: 5px;">
                        <div style="margin-bottom:15px;">
                            <label style="font-weight:bold; font-size:0.85rem; color:#6b7280; display:block; margin-bottom:5px;">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                            <div style="position:relative; margin-bottom:8px;">
                                <i class="fas fa-search" style="position:absolute; left:12px; top:13px; color:#d1d5db;"></i>
                                <input id="sw-search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="swal2-input" 
                                    style="margin:0; width:100%; padding-left:35px; border-radius:12px; font-size:0.95rem; border:1px solid #e5e7eb;">
                            </div>
                            <div style="border:1px solid #fbcfe8; border-radius:12px; overflow:hidden; background:#fff;">
                                <select id="sw-pid" size="5" style="width:100%; border:none; outline:none; font-family:'Sarabun'; font-size:0.95rem; padding:5px; cursor:pointer;"></select>
                            </div>
                        </div>
                        <div style="margin-bottom:15px;">
                            <label style="font-weight:bold; font-size:0.85rem; color:#6b7280; display:block; margin-bottom:5px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏ß‡∏ß/‡∏î‡∏î/‡∏õ‡∏õ‡∏õ‡∏õ)</label>
                            <input id="sw-date" type="date" class="swal2-input" style="margin:0; width:100%; border-radius:12px; font-family:'Sarabun';" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div style="margin-bottom:20px;">
                            <label style="font-weight:bold; font-size:0.85rem; color:#6b7280; display:block; margin-bottom:5px;">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤</label>
                            <input id="sw-time" type="time" class="swal2-input" style="margin:0; width:100%; border-radius:12px; text-align:center; font-size:1.2rem; font-weight:bold;" value="${new Date().toTimeString().slice(0,5)}">
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button id="btn-in" style="flex:1; padding:14px; border-radius:12px; border:2px solid #10b981; background:#f0fdf4; color:#10b981; font-weight:bold; cursor:pointer;" onclick="window.setMode('in')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤</button>
                            <button id="btn-out" style="flex:1; padding:14px; border-radius:12px; border:2px solid #e5e7eb; background:white; color:#9ca3af; font-weight:bold; cursor:pointer;" onclick="window.setMode('out')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏Å</button>
                        </div>
                    </div>
                `,
                didOpen: () => {
                    const search = document.getElementById('sw-search'), select = document.getElementById('sw-pid');
                    const update = (term = "") => {
                        const filtered = personnelList.filter(p => p.name.includes(term));
                        select.innerHTML = filtered.map(p => `<option value="${p.personnel_id}" style="padding:10px; border-bottom:1px solid #fdf2f8;">${p.name}</option>`).join('');
                        if(filtered.length) select.selectedIndex = 0;
                    };
                    search.addEventListener('input', (e) => update(e.target.value)); update();
                    window.setMode = (m) => {
                        mode = m;
                        const bin = document.getElementById('btn-in'), bout = document.getElementById('btn-out');
                        if(m === 'in'){
                            bin.style.background='#f0fdf4'; bin.style.borderColor='#10b981'; bin.style.color='#10b981';
                            bout.style.background='white'; bout.style.borderColor='#e5e7eb'; bout.style.color='#9ca3af';
                        } else {
                            bout.style.background='#fef2f2'; bout.style.borderColor='#ef4444'; bout.style.color='#ef4444';
                            bin.style.background='white'; bin.style.borderColor='#e5e7eb'; bin.style.color='#9ca3af';
                        }
                    };
                },
                preConfirm: () => {
                    const pid = document.getElementById('sw-pid').value;
                    const date = document.getElementById('sw-date').value;
                    const time = document.getElementById('sw-time').value;
                    if(!pid) return Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
                    const res = { id:`${date.replace(/-/g,'')}${pid}`, personnel_id:pid, full_name:personnelMap[pid], work_date:date, verified:0 };
                    res[mode === 'in' ? 'time_in' : 'time_out'] = time + ":00";
                    return res;
                }
            });
            if (f) { 
                await sbClient.from('TimeStamp').upsert([f], { onConflict: 'personnel_id, work_date' });
                render(); 
            }
        }
    }
</script>
</body>
</html>
