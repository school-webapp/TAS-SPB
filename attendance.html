<script>
    // ... (ส่วนประกาศตัวแปรและ setup อื่นๆ คงเดิม) ...

    // ==========================================
    // Modal: Personnel (Logic แยก Level 1 และ 2)
    // ==========================================
    async function openPersonnelModal(data = null) {
        const isEdit = !!data;
        const title = isEdit ? 'แก้ไขบุคลากร' : 'เพิ่มบุคลากรใหม่';

        // 1. ดึงข้อมูลประเภทบุคลากร (Personnel Type) มาทำ Datalist
        let typeOptions = '';
        try {
            const { data: types } = await sbClient.from('Personnel').select('personnel_type');
            if (types) {
                // กรองค่าซ้ำและค่าว่าง
                const uniqueTypes = [...new Set(types.map(t => t.personnel_type).filter(Boolean))];
                typeOptions = uniqueTypes.map(t => `<option value="${t}">`).join('');
            }
        } catch (e) { console.log(e); }

        // 2. สร้าง HTML ส่วนที่แตกต่างกันตาม User Level
        let adminFields = '';
        
        // เฉพาะ Level 1 เท่านั้นที่จะเห็นช่อง Level และ Password
        if (userLevel === '1') {
            adminFields = `
            <div style="margin-bottom:10px;">
                <label style="font-weight:bold;">ระดับสิทธิ์ (Level):</label>
                <select id="p-level" class="date-input">
                    <option value="" ${(!data || !data.level) ? 'selected' : ''}>ผู้ใช้งานทั่วไป (ค่าว่าง)</option>
                    <option value="2" ${data && data.level == 2 ? 'selected' : ''}>2 - Admin (ระดับ 2)</option>
                    <option value="1" ${data && data.level == 1 ? 'selected' : ''}>1 - Super Admin (สูงสุด)</option>
                </select>
            </div>
            <div style="margin-bottom:10px;">
                <label style="font-weight:bold;">Password:</label>
                <input id="p-pass" type="text" class="date-input" 
                    placeholder="${isEdit ? 'เว้นว่างหากไม่เปลี่ยน' : 'กำหนดรหัสผ่าน'}" 
                    value="">
            </div>
            `;
        }

        // 3. รวม HTML Form
        const htmlContent = `
        <div class="modal-form" style="text-align:left;">
            <div style="margin-bottom:10px;">
                <label style="font-weight:bold;">รหัสพนักงาน (ID):</label>
                <input id="p-id" class="date-input" value="${data ? data.personnel_id : ''}" ${isEdit ? 'readonly style="background:#eee;"' : ''}>
            </div>
            <div style="margin-bottom:10px;">
                <label style="font-weight:bold;">ชื่อ-สกุล:</label>
                <input id="p-name" class="date-input" value="${data ? data.name : ''}">
            </div>
            <div style="margin-bottom:10px;">
                <label style="font-weight:bold;">ตำแหน่ง/ประเภท:</label>
                <input id="p-type" class="date-input" list="type-list" value="${data ? (data.personnel_type || '') : ''}" placeholder="เลือก หรือ พิมพ์ใหม่">
                <datalist id="type-list">${typeOptions}</datalist>
            </div>

            ${adminFields}

             <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label><small>วันเริ่มงาน</small></label>
                    <input type="date" id="p-start" class="date-input" value="${data && data.start_date ? data.start_date : ''}">
                </div>
                 <div style="flex:1">
                    <label><small>วันสิ้นสุด</small></label>
                    <input type="date" id="p-end" class="date-input" value="${data && data.end_date ? data.end_date : ''}">
                </div>
            </div>
        </div>
        `;

        const { value: f } = await Swal.fire({
            title: title,
            html: htmlContent,
            showCancelButton: true,
            confirmButtonText: 'บันทึก',
            cancelButtonText: 'ยกเลิก',
            preConfirm: () => {
                const pid = document.getElementById('p-id').value.trim();
                const name = document.getElementById('p-name').value.trim();
                
                if (!pid || !name) return Swal.showValidationMessage('กรุณาระบุรหัสและชื่อ');

                // ดึงค่าพื้นฐาน
                let result = {
                    personnel_id: pid,
                    name: name,
                    personnel_type: document.getElementById('p-type').value, // ค่าจาก Datalist
                    start_date: document.getElementById('p-start').value || null,
                    end_date: document.getElementById('p-end').value || null
                };

                // จัดการ Level และ Password ตามสิทธิ์คนกดบันทึก
                if (userLevel === '1') {
                    // Level 1: เอาค่าจาก Form
                    const lvlVal = document.getElementById('p-level').value;
                    result.level = lvlVal ? parseInt(lvlVal) : null; // ถ้าเลือกค่าว่าง ให้เป็น null
                    result.Password = document.getElementById('p-pass').value;
                } else {
                    // Level 2: ตั้งค่า Default (เฉพาะตอนเพิ่มใหม่)
                    if (!isEdit) {
                        result.level = null; // ค่าว่าง (General User)
                        result.Password = ''; // ค่าว่าง
                    } 
                    // ถ้า Edit (ปกติ Level 2 ไม่เห็นปุ่ม Edit แต่กันเหนียว) จะไม่ส่ง field level/password ไป update เพื่อคงค่าเดิม
                }

                return result;
            }
        });

        if (f) {
            try {
                // สร้าง Payload สำหรับบันทึก
                const payload = {
                    name: f.name,
                    personnel_type: f.personnel_type,
                    start_date: f.start_date,
                    end_date: f.end_date
                };

                // เพิ่ม Level และ Password ลง Payload เฉพาะเงื่อนไขที่เหมาะสม
                if (userLevel === '1') {
                    payload.level = f.level;
                    if (f.Password) payload.Password = f.Password; // Update pass only if typed
                } else {
                    // Level 2 เพิ่มใหม่
                    if (!isEdit) {
                        payload.level = f.level;     // null
                        payload.Password = f.Password; // ''
                    }
                }

                if (isEdit) {
                    await sbClient.from('Personnel').update(payload).eq('personnel_id', f.personnel_id);
                } else {
                    payload.personnel_id = f.personnel_id;
                    // กรณีเพิ่มใหม่โดย Level 1 ถ้าไม่ได้พิมพ์รหัสผ่าน ให้ตั้ง Default เป็น 1234 หรือไม่? 
                    // ตามโจทย์บอก Level 1 คงฟอร์มเดิม (ปกติฟอร์มเดิมถ้าไม่กรอกอาจจะ error หรือเป็น null) 
                    // แต่เพื่อความปลอดภัย ถ้า User Level 1 ไม่กรอกรหัส ผมจะกันไว้ให้เป็น '1234' ถ้าต้องการ
                    // แต่ตามโจทย์ Level 2 ให้เป็น '' ดังนั้นตรงนี้ปล่อยตาม Logic ด้านบน
                    await sbClient.from('Personnel').insert([payload]);
                }

                Swal.fire('สำเร็จ', 'บันทึกข้อมูลเรียบร้อย', 'success');
                loadPersonnel();
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        }
    }

    // ... (ส่วนอื่นๆ คงเดิม) ...
</script>
