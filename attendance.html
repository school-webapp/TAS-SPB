<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô - TAS-SPB</title>
    
    <style>
        body { font-family: sans-serif; background-color: #f3f4f6; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .header { width: 100%; max-width: 400px; display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 0.9rem; color: #4b5563; }
        .logout { color: #ef4444; cursor: pointer; text-decoration: underline; border: none; background: none; font-size: 0.9rem; }
        
        .card { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        
        .date-display { font-size: 1.1rem; color: #374151; margin-bottom: 0.5rem; font-weight: bold; }
        .db-date-format { font-size: 0.8rem; color: #9ca3af; margin-bottom: 1.5rem; font-family: monospace; }
        
        .clock-box { background-color: #f3f4f6; border-radius: 12px; padding: 1rem; margin-bottom: 2rem; }
        .clock { font-size: 3rem; font-family: monospace; font-weight: bold; color: #1f2937; letter-spacing: 2px; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .btn { padding: 1.2rem; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; color: white; cursor: pointer; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-in { background-color: #22c55e; } 
        .btn-in:hover { background-color: #16a34a; }
        .btn-out { background-color: #f97316; }
        .btn-out:hover { background-color: #ea580c; }
        
        .status-area { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; font-size: 0.9rem; color: #4b5563; }
        .status-row { display: flex; justify-content: space-between; margin-top: 0.5rem; }
        .time-val { font-weight: bold; color: #111827; font-family: monospace; }
        
        #msg { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 100; }
    </style>

    <script src="supabase.js"></script>
</head>
<body>

    <div id="msg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>

    <div class="header">
        <div>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="userName" style="color: #2563eb; font-weight: bold;">...</span></div>
        <button class="logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="card">
        <div class="date-display" id="humanDate">-</div>
        <div class="db-date-format">DB Format: <span id="dbDateDisplay">-</span></div>
        
        <div class="clock-box">
            <div class="clock" id="clockDisplay">00:00:00</div>
        </div>

        <div class="btn-group">
            <button class="btn btn-in" onclick="recordTime('in')">üïí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</button>
            <button class="btn btn-out" onclick="recordTime('out')">üè† ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>
        </div>

        <div class="status-area">
            <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏à‡∏≤‡∏Å DB):</div>
            <div class="status-row">
                <span>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤:</span>
                <span id="timeInDisplay" class="time-val">-</span>
            </div>
            <div class="status-row">
                <span>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å:</span>
                <span id="timeOutDisplay" class="time-val">-</span>
            </div>
        </div>
    </div>

    <script>
        // --- Config ---
        const SUPABASE_URL = "https://tdcmbskmlrwhbjrjyjkk.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkY21ic2ttbHJ3aGJqcmp5amtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTY4NTYsImV4cCI6MjA3ODE5Mjg1Nn0.FeYe75J8X_2LoQgG_JWyPNCKcuCL_otsmSW0s5bijAg";
        
        let client = null;
        let userData = null;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        function showToast(text, isError = false) {
            const msg = document.getElementById('msg');
            msg.innerText = text;
            msg.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
            msg.style.opacity = '1';
            setTimeout(() => { msg.style.opacity = '0'; }, 3000);
        }

        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Login ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î Library
        function init() {
            try {
                const stored = localStorage.getItem('tas_user');
                if (!stored) {
                    window.location.href = 'login.html';
                    return;
                }
                userData = JSON.parse(stored);
                document.getElementById('userName').innerText = userData.name || userData.personnel_id;

                if (typeof window.supabase === 'undefined') {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå supabase.js");
                    return;
                }
                client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                startClock();
                loadTodayRecord();

            } catch (e) {
                console.error(e);
                window.location.href = 'login.html';
            }
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢ Format ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        function getDBFormatValues() {
            const now = new Date();
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ ‡∏õ‡∏µ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ß‡∏±‡∏ô ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏ö‡∏ö Local Time (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ UTC)
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            return {
                date: `${year}-${month}-${day}`, // YYYY-MM-DD
                time: `${hours}:${minutes}:${seconds}`, // HH:MM:SS
                obj: now
            };
        }

        function startClock() {
            setInterval(() => {
                const val = getDBFormatValues();
                // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                document.getElementById('clockDisplay').innerText = val.time;
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö DB (YYYY-MM-DD)
                document.getElementById('dbDateDisplay').innerText = val.date;
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
                document.getElementById('humanDate').innerText = val.obj.toLocaleDateString('th-TH', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
            }, 1000);
            
            // ‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ 1 ‡∏ß‡∏¥
            const val = getDBFormatValues();
            document.getElementById('clockDisplay').innerText = val.time;
        }

        // 3. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (TimeStampPlus)
        async function loadTodayRecord() {
            if (!client) return;
            const val = getDBFormatValues();
            const todayDB = val.date; // ‡πÉ‡∏ä‡πâ YYYY-MM-DD ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤

            try {
                const { data, error } = await client
                    .from('TimeStampPlus')
                    .select('*')
                    .eq('personnel_id', userData.personnel_id)
                    .eq('work_date', todayDB)
                    .single();

                if (data) {
                    document.getElementById('timeInDisplay').innerText = data.time_in || "-";
                    document.getElementById('timeOutDisplay').innerText = data.time_out || "-";
                    return data;
                } else {
                    document.getElementById('timeInDisplay').innerText = "-";
                    document.getElementById('timeOutDisplay').innerText = "-";
                    return null;
                }
            } catch (err) {
                // PGRST116 = ‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡∏õ‡∏Å‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤)
                if (err.code !== 'PGRST116') console.error(err);
                return null;
            }
        }

        // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
        async function recordTime(type) {
            if (!client) return;
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${type === 'in' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' : '‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô'} ?`)) return;

            const val = getDBFormatValues();
            const todayDB = val.date; // YYYY-MM-DD
            const timeDB = val.time;  // HH:MM:SS

            try {
                const existing = await loadTodayRecord();
                let error = null;

                if (type === 'in') {
                    if (existing) {
                        // ‡∏°‡∏µ record ‡πÅ‡∏•‡πâ‡∏ß -> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï time_in (‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡∏°‡πà)
                        const { error: upError } = await client
                            .from('TimeStampPlus')
                            .update({ time_in: timeDB })
                            .eq('id', existing.id);
                        error = upError;
                    } else {
                        // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ -> Insert ‡πÉ‡∏´‡∏°‡πà
                        const { error: insError } = await client
                            .from('TimeStampPlus')
                            .insert([{
                                personnel_id: userData.personnel_id,
                                full_name: userData.name,
                                work_date: todayDB,
                                time_in: timeDB
                            }]);
                        error = insError;
                    }
                } else { // type === 'out'
                    if (existing) {
                        // ‡∏°‡∏µ record ‡πÅ‡∏•‡πâ‡∏ß -> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï time_out
                        const { error: upError } = await client
                            .from('TimeStampPlus')
                            .update({ time_out: timeDB })
                            .eq('id', existing.id);
                        error = upError;
                    } else {
                        // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ (‡∏•‡∏á‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤?) -> Insert ‡πÉ‡∏´‡∏°‡πà
                        const { error: insError } = await client
                            .from('TimeStampPlus')
                            .insert([{
                                personnel_id: userData.personnel_id,
                                full_name: userData.name,
                                work_date: todayDB,
                                time_out: timeDB
                            }]);
                        error = insError;
                    }
                }

                if (error) throw error;

                showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                loadTodayRecord(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

            } catch (err) {
                console.error(err);
                showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message, true);
            }
        }

        function logout() {
            localStorage.removeItem('tas_user');
            window.location.href = 'login.html';
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        init();
    </script>
</body>
</html>
