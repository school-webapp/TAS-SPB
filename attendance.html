<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö - TAS-SPB</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="ios-fix.js"></script>

    <style>
        :root {
            --primary-color: #ec4899;
            --bg: #f3f4f6;
            --white: #ffffff;
            --text: #1f2937;
            --muted: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 20px;
            padding-bottom: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container { max-width: 1000px; margin: 0 auto; width: 100%; }

        /* Header */
        .header-section {
            background: white;
            width: 100%;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .header-title { display: flex; align-items: center; gap: 15px; }
        .icon-box {
            width: 50px; height: 50px; background: var(--primary-color);
            color: white; border-radius: 12px; display: flex;
            align-items: center; justify-content: center; font-size: 1.5rem;
        }
        .header-text h2 { margin: 0; color: #1f2937; font-size: 1.5rem; }
        .header-text span { color: #6b7280; font-size: 0.9rem; }

        .btn-home {
            text-decoration: none; color: #4b5563; font-weight: bold;
            background: #f3f4f6; padding: 8px 16px; border-radius: 20px;
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .btn-home:hover { background: #e5e7eb; }

        /* Controls */
        .controls-card {
            background: var(--white); padding: 20px; border-radius: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); margin-bottom: 20px;
            display: flex; flex-direction: column; gap: 15px;
        }

        .date-input {
            width: 100%; padding: 12px; border: 1px solid var(--border);
            border-radius: 10px; font-family: 'Sarabun'; font-size: 1rem;
            background: #f9fafb;
        }

        .filter-status { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-filter {
            padding: 8px 16px; border-radius: 10px; font-size: 0.9rem;
            font-weight: 600; cursor: pointer; border: 1px solid transparent;
            display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .btn-filter.active { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }

        .search-box-container {
            display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;
            background: white; padding: 10px; border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Tabs */
        .tabs {
            display: flex; background: #e5e7eb; padding: 5px;
            border-radius: 12px; flex-wrap: wrap;
        }
        .tab-btn {
            flex: 1; padding: 12px; border: none; background: transparent;
            border-radius: 8px; cursor: pointer; font-weight: bold;
            color: var(--muted); font-family: 'Sarabun'; transition: all 0.2s;
            min-width: 100px;
        }
        .tab-btn.active {
            background: var(--white); color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .content-section { display: none; animation: fadeIn 0.3s; }
        .content-section.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Data Items */
        .data-list { display: grid; gap: 15px; }
        .data-item {
            background: var(--white); padding: 15px; border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-left: 5px solid transparent;
            display: flex; justify-content: space-between; align-items: center;
        }

        .item-att { border-left-color: var(--primary-color); }
        .item-leave { border-left-color: var(--warning); }
        .item-personnel { border-left-color: var(--info); }

        .info h4 { margin: 0; font-size: 1rem; }
        .info p {
            margin: 5px 0 0; font-size: 0.85rem; color: var(--muted);
            display: flex; gap: 8px; flex-wrap: wrap;
        }

        .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .bg-green { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .bg-red { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .bg-orange { background: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }
        .bg-blue { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .bg-gray { background: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }

        .actions { display: flex; gap: 8px; }
        .btn-icon {
            width: 36px; height: 36px; border-radius: 8px; border: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-edit { background: #fffbeb; color: #d97706; }
        .btn-del { background: #fef2f2; color: #dc2626; }

        /* Pagination */
        .pagination {
            display: flex; justify-content: center; align-items: center;
            gap: 15px; margin-top: 20px; padding: 10px;
        }
        .btn-page {
            padding: 8px 16px; border-radius: 12px; border: none;
            background: white; color: var(--text); font-weight: bold;
            cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex; align-items: center; gap: 5px;
        }
        .btn-page:disabled { opacity: 0.5; cursor: not-allowed; }

        .fab {
            position: fixed; bottom: 20px; right: 20px; background: var(--success);
            color: white; width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            cursor: pointer; border: none; z-index: 100;
        }

        @media (max-width: 600px) {
            .header-section { flex-direction: column; align-items: flex-start; gap: 15px; }
            .btn-home { align-self: flex-start; }
            .data-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .actions { width: 100%; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 10px; }
            .search-box-container { flex-direction: column; }
        }
    </style>

    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>
</head>

<body>
    <div class="container">
        <div class="header-section">
            <div class="header-title">
                <div class="icon-box"><i class="fas fa-calendar-check"></i></div>
                <div class="header-text">
                    <h2 id="pageTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    <span id="pageSubTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤, ‡∏ß‡∏±‡∏ô‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</span>
                </div>
            </div>
            <a href="menu.html" class="btn-home">
                <i class="fas fa-home"></i> ‡πÄ‡∏°‡∏ô‡∏π
            </a>
        </div>

        <div class="controls-card">
            <div id="date-control-group">
                <label style="font-weight:bold; color:#6b7280;">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</label>
                <input type="date" id="filterDate" class="date-input" onchange="loadAttendance()">
            </div>
            <div class="tabs">
                <button id="btn-tab-att" class="tab-btn active" onclick="switchTab('att')">üïí ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>
                <button id="btn-tab-leave" class="tab-btn" onclick="switchTab('leave')">‚úàÔ∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏≤</button>
                <button id="btn-tab-personnel" class="tab-btn" onclick="switchTab('personnel')" style="display:none;">üë• ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</button>
            </div>
        </div>

        <div id="tab-att" class="content-section active">
            <div id="filter-container" class="filter-status" style="display:none;">
                <button id="filter-all" class="btn-filter bg-green active" onclick="setStatusFilter('all')">
                    <i class="fas fa-list"></i> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                <button id="filter-incomplete" class="btn-filter bg-gray" onclick="setStatusFilter('incomplete')">
                    <i class="fas fa-exclamation-triangle"></i> ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
                </button>
            </div>
            <div id="list-att" class="data-list">
                <div style="text-align:center; padding:30px; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>

        <div id="tab-leave" class="content-section">
            <div class="search-box-container">
                <div style="flex: 2; min-width: 200px;">
                    <input type="text" id="leave-search-name" class="date-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." onkeyup="if(event.key==='Enter') searchLeave()">
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <input type="date" id="leave-search-date" class="date-input">
                </div>
                <button class="btn-filter bg-green" onclick="searchLeave()" style="color: #166534; background-color: #dcfce7; border: 1px solid #bbf7d0;">
                    <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
                <button class="btn-filter bg-gray" onclick="clearLeaveFilter()">
                    <i class="fas fa-undo"></i>
                </button>
            </div>
            <div id="list-leave" class="data-list">
                <div style="text-align:center; padding:30px; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
            <div class="pagination">
                <button id="leave-prev-btn" class="btn-page" onclick="changeLeavePage(-1)" disabled><i class="fas fa-chevron-left"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                <span id="leave-page-num" style="color:#6b7280; font-weight:bold;">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
                <button id="leave-next-btn" class="btn-page" onclick="changeLeavePage(1)" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div id="tab-personnel" class="content-section">
            <div class="search-box-container">
                <div style="flex: 1;">
                    <input type="text" id="personnel-search" class="date-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™..." onkeyup="if(event.key==='Enter') searchPersonnel()">
                </div>
                <button class="btn-filter bg-blue" onclick="searchPersonnel()" style="color: #1e40af; background-color: #dbeafe; border: 1px solid #bfdbfe;">
                    <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
                <button class="btn-filter bg-gray" onclick="clearPersonnelFilter()">
                    <i class="fas fa-undo"></i>
                </button>
            </div>
            <div id="list-personnel" class="data-list">
                <div style="text-align:center; padding:30px; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
            <div class="pagination">
                <button id="personnel-prev-btn" class="btn-page" onclick="changePersonnelPage(-1)" disabled><i class="fas fa-chevron-left"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                <span id="personnel-page-num" style="color:#6b7280; font-weight:bold;">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
                <button id="personnel-next-btn" class="btn-page" onclick="changePersonnelPage(1)" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>

    <button class="fab" onclick="handleAddClick()"><i class="fas fa-plus"></i></button>

    <script>
        // ==========================================
        // Security Check
        // ==========================================
        const storedUser = localStorage.getItem('tas_user');
        if (!storedUser) { window.location.href = 'login.html'; }

        const user = JSON.parse(storedUser);
        const userLevel = String(user.level || '').trim();

        if (userLevel !== '1' && userLevel !== '2') {
            document.body.style.display = 'none';
            setTimeout(() => {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ',
                    text: `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ`,
                    confirmButtonText: '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π'
                }).then(() => { window.location.replace('menu.html'); });
            }, 100);
            throw new Error("Unauthorized Access");
        }

        if (typeof sbClient === 'undefined') Swal.fire('Error', 'Supabase Client Not Found', 'error');

        // Global State
        let currentTab = 'att';
        let statusFilter = 'all';
        let personnelMap = {};
        let leaveTypes = [];

        // Pagination Vars
        let leavePage = 0;
        const LEAVE_PER_PAGE = 10;
        
        let personnelPage = 0;
        const PERSONNEL_PER_PAGE = 10;

        document.addEventListener('DOMContentLoaded', async () => {
            const dateInput = document.getElementById('filterDate');
            if (!dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
            
            await loadMasterData();

            // Set Title & Subtitle based on User Level
            if (userLevel === '2') {
                // Level 2: Default to Leave tab, Hide Attendance
                document.getElementById('pageTitle').innerText = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö";
                document.getElementById('pageSubTitle').innerText = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£"; 
                document.getElementById('btn-tab-att').style.display = 'none';
                document.getElementById('btn-tab-personnel').style.display = 'block';
                switchTab('leave');
            } else {
                // Level 1: Default to Attendance
                document.getElementById('pageTitle').innerText = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö";
                document.getElementById('pageSubTitle').innerText = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤, ‡∏ß‡∏±‡∏ô‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£";
                document.getElementById('btn-tab-personnel').style.display = 'block';
                loadAttendance();
            }
        });

        window.switchTab = function (tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`btn-tab-${tabName}`);
            if (btn) btn.classList.add('active');

            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            const dateControl = document.getElementById('date-control-group');
            document.getElementById('filter-container').style.display = 'none';
            
            if (tabName === 'att') {
                if (dateControl) dateControl.style.display = 'block';
                loadAttendance();
            } else if (tabName === 'leave') {
                if (dateControl) dateControl.style.display = 'none';
                loadLeaves();
            } else if (tabName === 'personnel') {
                if (dateControl) dateControl.style.display = 'none';
                loadPersonnel();
            }
        }

        async function loadMasterData() {
            try {
                const { data: users } = await sbClient.from('Personnel').select('personnel_id, name');
                if (users) users.forEach(u => personnelMap[u.personnel_id] = u.name);
                const { data: settings } = await sbClient.from(TAS_CONFIG.TABLE_SETTINGS).select('value').eq('key', 'leave_types').single();
                leaveTypes = (settings && settings.value) ? settings.value.split(',') : ['‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', '‡∏•‡∏≤‡∏Å‡∏¥‡∏à'];
            } catch (e) { console.error(e); }
        }

        // ==========================================
        // Tab 1: Attendance
        // ==========================================
        window.setStatusFilter = function (status) {
            statusFilter = status;
            const btnAll = document.getElementById('filter-all');
            const btnInc = document.getElementById('filter-incomplete');
            if (status === 'all') {
                btnAll.classList.add('active', 'bg-green'); btnAll.classList.remove('bg-gray');
                btnInc.classList.remove('active', 'bg-red'); btnInc.classList.add('bg-gray');
            } else {
                btnAll.classList.remove('active', 'bg-green'); btnAll.classList.add('bg-gray');
                btnInc.classList.add('active', 'bg-red'); btnInc.classList.remove('bg-gray');
            }
            loadAttendance();
        }

        async function loadAttendance() {
            if (userLevel !== '1') return;
            const date = document.getElementById('filterDate').value;
            const container = document.getElementById('list-att');
            const filterContainer = document.getElementById('filter-container');

            container.innerHTML = `<div style="text-align:center; padding:20px; color:#ec4899;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤...</div>`;

            try {
                let query = sbClient.from(TAS_CONFIG.TABLE_TARGET).select('*').eq('work_date', date);
                if (statusFilter === 'incomplete') query = query.or('time_in.is.null,time_out.is.null');
                const { data, error } = await query.order('time_in');
                if (error) throw error;

                if (!data || data.length === 0) {
                     filterContainer.style.display = (statusFilter === 'all') ? 'none' : 'flex';
                     container.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
                     return;
                }

                filterContainer.style.display = 'flex';
                container.innerHTML = data.map(r => `
            <div class="data-item item-att">
                <div class="info">
                    <h4>${r.full_name || personnelMap[r.personnel_id] || r.personnel_id}</h4>
                    <p>
                        <span class="badge ${r.time_in ? 'bg-green' : 'bg-red'}">‡πÄ‡∏Ç‡πâ‡∏≤: ${r.time_in ? r.time_in.slice(0, 5) : '‡∏Ç‡∏≤‡∏î'}</span>
                        <span class="badge ${r.time_out ? 'bg-green' : 'bg-red'}">‡∏≠‡∏≠‡∏Å: ${r.time_out ? r.time_out.slice(0, 5) : '‡∏Ç‡∏≤‡∏î'}</span>
                        <small>(${r.personnel_id})</small>
                    </p>
                </div>
                <div class="actions">
                    <button class="btn-icon btn-edit" onclick="editAtt('${r.id}', '${r.full_name}', '${r.time_in || ''}', '${r.time_out || ''}')"><i class="fas fa-pen"></i></button>
                    <button class="btn-icon btn-del" onclick="delAtt('${r.id}')"><i class="fas fa-trash"></i></button>
                </div>
            </div>`).join('');
            } catch (err) { container.innerHTML = `<div style="text-align:center; color:red;">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`; }
        }

        // ==========================================
        // Tab 2: Leaves
        // ==========================================
        function searchLeave() { leavePage = 0; loadLeaves(); }
        function clearLeaveFilter() {
            document.getElementById('leave-search-name').value = '';
            document.getElementById('leave-search-date').value = '';
            leavePage = 0; loadLeaves();
        }
        async function loadLeaves() {
            const container = document.getElementById('list-leave');
            const btnPrev = document.getElementById('leave-prev-btn');
            const btnNext = document.getElementById('leave-next-btn');
            const pageNumDisplay = document.getElementById('leave-page-num');
            const nameSearch = document.getElementById('leave-search-name').value.trim().toLowerCase();
            const dateSearch = document.getElementById('leave-search-date').value;

            container.innerHTML = `<div style="text-align:center; padding:20px; color:#f59e0b;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤...</div>`;
            const start = leavePage * LEAVE_PER_PAGE;
            const end = start + LEAVE_PER_PAGE - 1;

            try {
                let query = sbClient.from('Leave_records').select('*').neq('leave_type', '‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô');
                if (dateSearch) query = query.eq('leave_date', dateSearch);
                if (nameSearch) {
                    const matchingIds = Object.keys(personnelMap).filter(id => (personnelMap[id] || '').toLowerCase().includes(nameSearch) || id.includes(nameSearch));
                    if (matchingIds.length > 0) query = query.in('personnel_id', matchingIds);
                    else query = query.eq('personnel_id', 'no_match');
                }
                const { data, error } = await query.order('leave_date', { ascending: false }).range(start, end);
                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">${leavePage === 0 ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</div>`;
                    btnNext.disabled = true; btnPrev.disabled = (leavePage === 0);
                    pageNumDisplay.innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${leavePage + 1}`;
                    return;
                }
                container.innerHTML = data.map(r => `
            <div class="data-item item-leave">
                <div class="info">
                    <h4>${personnelMap[r.personnel_id] || r.personnel_id}</h4>
                    <p><span class="badge bg-orange">${r.leave_type}</span><span style="color:#333; font-weight:bold;">${formatThaiDate(r.leave_date)}</span></p>
                </div>
                <div class="actions">
                    <button class="btn-icon btn-edit" onclick="openLeaveModal('${r.id}', '${r.personnel_id}', '${r.leave_type}')"><i class="fas fa-pen"></i></button>
                    <button class="btn-icon btn-del" onclick="delLeave('${r.id}')"><i class="fas fa-trash"></i></button>
                </div>
            </div>`).join('');
                btnPrev.disabled = (leavePage === 0); btnNext.disabled = (data.length < LEAVE_PER_PAGE);
                pageNumDisplay.innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${leavePage + 1}`;
            } catch (err) { container.innerHTML = `<div style="text-align:center; color:red;">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`; }
        }
        window.changeLeavePage = function (delta) {
            const newPage = leavePage + delta;
            if (newPage < 0) return;
            leavePage = newPage; loadLeaves();
        }

        // ==========================================
        // Tab 3: Personnel
        // ==========================================
        function searchPersonnel() { personnelPage = 0; loadPersonnel(); }
        function clearPersonnelFilter() {
            document.getElementById('personnel-search').value = '';
            personnelPage = 0; loadPersonnel();
        }
        window.changePersonnelPage = function (delta) {
            const newPage = personnelPage + delta;
            if (newPage < 0) return;
            personnelPage = newPage; loadPersonnel();
        }

        async function loadPersonnel() {
            const container = document.getElementById('list-personnel');
            const btnPrev = document.getElementById('personnel-prev-btn');
            const btnNext = document.getElementById('personnel-next-btn');
            const pageNumDisplay = document.getElementById('personnel-page-num');
            const searchVal = document.getElementById('personnel-search').value.trim();

            container.innerHTML = `<div style="text-align:center; padding:20px; color:#3b82f6;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£...</div>`;

            const start = personnelPage * PERSONNEL_PER_PAGE;
            const end = start + PERSONNEL_PER_PAGE - 1;

            try {
                let query = sbClient.from('Personnel').select('*');
                if (searchVal) query = query.or(`name.ilike.%${searchVal}%,personnel_id.ilike.%${searchVal}%`);
                const { data, error } = await query.order('personnel_id', { ascending: true }).range(start, end);

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">${personnelPage === 0 ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£' : '‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</div>`;
                    btnNext.disabled = true; btnPrev.disabled = (personnelPage === 0);
                    pageNumDisplay.innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${personnelPage + 1}`;
                    return;
                }

                container.innerHTML = data.map(p => {
                    // Level 1: ‡πÄ‡∏´‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö
                    // Level 2: ‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏° (Empty string)
                    const actionsHtml = (userLevel === '1') ? 
                    `<div class="actions">
                        <button class="btn-icon btn-edit" onclick='openPersonnelModal(${JSON.stringify(p).replace(/'/g, "&#39;")})'><i class="fas fa-pen"></i></button>
                        <button class="btn-icon btn-del" onclick="deletePersonnel('${p.personnel_id}', '${p.name}')"><i class="fas fa-trash"></i></button>
                    </div>` : '';

                    return `
                    <div class="data-item item-personnel">
                        <div class="info">
                            <h4>${p.name}</h4>
                            <p>
                                <span class="badge bg-blue">ID: ${p.personnel_id}</span>
                                <span class="badge bg-gray">${p.personnel_type || '-'}</span>
                                <span class="badge ${p.level == 1 ? 'bg-red' : (p.level == 2 ? 'bg-orange' : 'bg-green')}">Level: ${p.level || '-'}</span>
                            </p>
                        </div>
                        ${actionsHtml}
                    </div>`;
                }).join('');

                btnPrev.disabled = (personnelPage === 0);
                btnNext.disabled = (data.length < PERSONNEL_PER_PAGE);
                pageNumDisplay.innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${personnelPage + 1}`;
                data.forEach(u => personnelMap[u.personnel_id] = u.name);
            } catch (err) { console.error(err); container.innerHTML = `<div style="text-align:center; color:red;">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`; }
        }

        // ==========================================
        // Main Action Handler (FAB)
        // ==========================================
        window.handleAddClick = function () {
            if (currentTab === 'att' && userLevel === '1') openAttModal();
            else if (currentTab === 'leave') openLeaveModal();
            else if (currentTab === 'personnel') openPersonnelModal(); // Both Level 1 & 2 can Add
        }

        // ==========================================
        // Modals
        // ==========================================
        function formatThaiDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
        }

        async function openAttModal() {
             const filterDateVal = document.getElementById('filterDate').value;
             const { value: f } = await Swal.fire({
                title: '‚ûï ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',
                html: `<div class="modal-form"><div style="margin-bottom:10px;"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label><input type="date" id="a-date" class="date-input" value="${filterDateVal}"></div><div style="position:relative; margin-bottom:10px;"><label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</label><input id="s-pid-att" class="date-input"><div id="s-res-att" class="search-results"></div></div><div style="margin-bottom:10px;"><label>‡∏£‡∏´‡∏±‡∏™:</label><input id="a-pid" class="date-input" readonly style="background:#f3f4f6"><input id="a-name" type="hidden"></div><div style="display:flex;gap:10px;"><div style="flex:1"><input type="time" id="a-time" class="date-input" value="${new Date().toTimeString().slice(0,5)}"></div><div style="flex:1"><select id="a-type" class="date-input"><option value="in">‡πÄ‡∏Ç‡πâ‡∏≤</option><option value="out">‡∏≠‡∏≠‡∏Å</option></select></div></div></div>`,
                showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                didOpen: () => setupSearch('s-pid-att', 's-res-att', 'a-pid', 'a-name'),
                preConfirm: () => ({ pid: document.getElementById('a-pid').value, name: document.getElementById('a-name').value, date: document.getElementById('a-date').value, time: document.getElementById('a-time').value, type: document.getElementById('a-type').value })
             });
             if(f && f.pid) {
                 const { data: ex } = await sbClient.from(TAS_CONFIG.TABLE_TARGET).select('id,time_in,time_out').eq('personnel_id', f.pid).eq('work_date', f.date).maybeSingle();
                 if(ex) { await sbClient.from(TAS_CONFIG.TABLE_TARGET).update(f.type=='in'?{time_in:f.time}:{time_out:f.time}).eq('id', ex.id); }
                 else { await sbClient.from(TAS_CONFIG.TABLE_TARGET).insert([{id:Date.now().toString(), personnel_id:f.pid, full_name:f.name, work_date:f.date, time_in:f.type=='in'?f.time:null, time_out:f.type=='out'?f.time:null, verified:0}]); }
                 Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß','success'); loadAttendance();
             }
        }

        async function openLeaveModal(id = null, pid = '', type = '') {
            const isEdit = !!id;
            const today = new Date().toISOString().split('T')[0];
            const typeOpts = leaveTypes.map(t => `<option value="${t}" ${t === type ? 'selected' : ''}>${t}</option>`).join('');
            const { value: f } = await Swal.fire({
                title: isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏•‡∏≤' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏≤',
                html: `<div class="modal-form">${!isEdit ? `<div><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label><input type="date" id="l-date" class="date-input" value="${today}"></div><div><label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</label><input id="s-pid-leave" class="date-input"><div id="s-res-leave" class="search-results"></div><input type="hidden" id="l-pid"></div>` : `<div><label>‡∏£‡∏´‡∏±‡∏™:</label><input class="date-input" value="${pid}" readonly style="background:#f3f4f6"><input type="hidden" id="l-pid-val" value="${pid}"></div>`}<div><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</label><select id="l-type" class="date-input">${typeOpts}</select></div></div>`,
                showCancelButton: true, confirmButtonText: 'OK',
                didOpen: () => { if (!isEdit) setupSearch('s-pid-leave', 's-res-leave', 'l-pid', null); },
                preConfirm: () => ({ pid: isEdit ? document.getElementById('l-pid-val').value : document.getElementById('l-pid').value, type: document.getElementById('l-type').value, date: isEdit ? null : document.getElementById('l-date').value })
            });
            if (f && f.pid) {
                const pl = { personnel_id: f.pid, leave_type: f.type, status: 'approved' };
                if (f.date) pl.leave_date = f.date;
                if (isEdit) await sbClient.from('Leave_records').update(pl).eq('id', id);
                else { pl.id = Date.now(); await sbClient.from('Leave_records').insert([pl]); }
                loadLeaves(); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        }

        async function openPersonnelModal(data = null) {
            const isEdit = !!data;
            const title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÉ‡∏´‡∏°‡πà';
            
            let typeOptions = '';
            try {
                const { data: types } = await sbClient.from('Personnel').select('personnel_type');
                if (types) {
                    const uniqueTypes = [...new Set(types.map(t => t.personnel_type).filter(Boolean))];
                    typeOptions = uniqueTypes.map(t => `<option value="${t}">`).join('');
                }
            } catch(e) { console.log(e); }

            let adminFields = '';
            // Only Level 1 sees Level/Password inputs
            if (userLevel === '1') {
                adminFields = `
                <div style="margin-bottom:10px;">
                    <label style="font-weight:bold;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Level):</label>
                    <select id="p-level" class="date-input">
                        <option value="" ${(!data || !data.level) ? 'selected' : ''}>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á)</option>
                        <option value="2" ${data && data.level == 2 ? 'selected' : ''}>2 - Admin (‡∏£‡∏∞‡∏î‡∏±‡∏ö 2)</option>
                        <option value="1" ${data && data.level == 1 ? 'selected' : ''}>1 - Super Admin (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)</option>
                    </select>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="font-weight:bold;">Password:</label>
                    <input id="p-pass" type="text" class="date-input" placeholder="${isEdit ? '‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô' : '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'}" value="">
                </div>
                `;
            }

            const htmlContent = `
            <div class="modal-form" style="text-align:left;">
                <div style="margin-bottom:10px;">
                    <label style="font-weight:bold;">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (ID):</label>
                    <input id="p-id" class="date-input" value="${data ? data.personnel_id : ''}" ${isEdit ? 'readonly style="background:#eee;"' : ''}>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="font-weight:bold;">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</label>
                    <input id="p-name" class="date-input" value="${data ? data.name : ''}">
                </div>
                <div style="margin-bottom:10px;">
                    <label style="font-weight:bold;">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</label>
                    <input id="p-type" class="date-input" list="type-list" value="${data ? (data.personnel_type||'') : ''}" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà">
                    <datalist id="type-list">${typeOptions}</datalist>
                </div>
                
                ${adminFields}

                 <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label><small>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</small></label>
                        <input type="date" id="p-start" class="date-input" value="${data && data.start_date ? data.start_date : ''}">
                    </div>
                     <div style="flex:1">
                        <label><small>‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</small></label>
                        <input type="date" id="p-end" class="date-input" value="${data && data.end_date ? data.end_date : ''}">
                    </div>
                </div>
            </div>
            `;

            const { value: f } = await Swal.fire({
                title: title,
                html: htmlContent,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                preConfirm: () => {
                    const pid = document.getElementById('p-id').value.trim();
                    const name = document.getElementById('p-name').value.trim();
                    if (!pid || !name) return Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠');
                    
                    let result = {
                        personnel_id: pid,
                        name: name,
                        personnel_type: document.getElementById('p-type').value,
                        start_date: document.getElementById('p-start').value || null,
                        end_date: document.getElementById('p-end').value || null
                    };

                    if (userLevel === '1') {
                        const lvlVal = document.getElementById('p-level').value;
                        result.level = lvlVal ? parseInt(lvlVal) : null;
                        result.Password = document.getElementById('p-pass').value;
                    } else {
                        if (!isEdit) {
                            result.level = null;
                            result.Password = '';
                        }
                    }
                    return result;
                }
            });

            if (f) {
                try {
                    const payload = {
                        name: f.name,
                        personnel_type: f.personnel_type,
                        start_date: f.start_date,
                        end_date: f.end_date
                    };
                    
                    if (userLevel === '1') {
                        payload.level = f.level;
                        if (f.Password) payload.Password = f.Password;
                    } else {
                        if (!isEdit) {
                            payload.level = f.level;
                            payload.Password = f.Password;
                        }
                    }

                    if (isEdit) {
                        await sbClient.from('Personnel').update(payload).eq('personnel_id', f.personnel_id);
                    } else {
                        payload.personnel_id = f.personnel_id;
                        await sbClient.from('Personnel').insert([payload]);
                    }
                    
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                    loadPersonnel();
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        }

        async function deletePersonnel(pid, name) {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?',
                text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${name}" (${pid}) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
            });

            if (result.isConfirmed) {
                try {
                    const { error } = await sbClient.from('Personnel').delete().eq('personnel_id', pid);
                    if (error) throw error;
                    Swal.fire('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '', 'success');
                    loadPersonnel();
                } catch (error) {
                    Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á)', 'error');
                }
            }
        }

        // ==========================================
        // Utilities
        // ==========================================
        function setupSearch(inpId, resId, pidId, nameId) {
            const inp = document.getElementById(inpId), res = document.getElementById(resId);
            if (!inp) return;
            inp.addEventListener('input', async (e) => {
                const kw = e.target.value.trim();
                if (kw.length < 1) { res.style.display = 'none'; return; }
                const { data } = await sbClient.from('Personnel').select('personnel_id, name').ilike('name', `%${kw}%`).limit(5);
                res.innerHTML = '';
                if (data && data.length) {
                    res.style.display = 'block';
                    data.forEach(p => {
                        const d = document.createElement('div'); d.className = 'search-item';
                        d.style.padding = '8px'; d.style.borderBottom = '1px solid #eee'; d.style.cursor = 'pointer';
                        d.innerHTML = `<b>${p.name}</b> <small>(${p.personnel_id})</small>`;
                        d.onclick = () => {
                            document.getElementById(pidId).value = p.personnel_id;
                            if (nameId) document.getElementById(nameId).value = p.name;
                            inp.value = p.name;
                            res.style.display = 'none';
                        };
                        res.appendChild(d);
                    });
                } else res.style.display = 'none';
            });
        }

        async function delAtt(id) { if ((await Swal.fire({ title: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?', icon: 'warning', showCancelButton: true })).isConfirmed) { await sbClient.from(TAS_CONFIG.TABLE_TARGET).delete().eq('id', id); loadAttendance(); } }
        async function delLeave(id) { if ((await Swal.fire({ title: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?', icon: 'warning', showCancelButton: true })).isConfirmed) { await sbClient.from('Leave_records').delete().eq('id', id); loadLeaves(); } }
        async function editAtt(id, name, tIn, tOut) {
            const { value: f } = await Swal.fire({ title: `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${name}`, html: `<div style="display:flex; gap:10px;"><input type="time" id="e-in" class="date-input" value="${tIn}"><input type="time" id="e-out" class="date-input" value="${tOut}"></div>`, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', preConfirm: () => ({ in: document.getElementById('e-in').value, out: document.getElementById('e-out').value }) });
            if (f) { await sbClient.from(TAS_CONFIG.TABLE_TARGET).update({ time_in: f.in || null, time_out: f.out || null }).eq('id', id); loadAttendance(); }
        }
    </script>
</body>
</html>
