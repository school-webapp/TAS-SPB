<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô - TAS-SPB</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <style>
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å */
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        
        /* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö) */
        .nav-bar { width: 100%; max-width: 400px; display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .back-btn { 
            background: white; color: #4338ca; border: 1px solid #e0e7ff; 
            padding: 8px 15px; border-radius: 20px; cursor: pointer; 
            text-decoration: none; font-weight: bold; font-size: 0.9rem; 
            transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .back-btn:hover { background: #e0e7ff; transform: translateY(-2px); }
        .user-display { font-weight: bold; color: #4b5563; display: flex; align-items: center; gap: 5px; }

        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏•‡∏±‡∏Å */
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 100%; max-width: 400px; text-align: center; }
        
        /* ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ */
        .date-display { font-size: 1.2rem; color: #1f2937; margin-bottom: 0.5rem; font-weight: bold; }
        .db-date-format { font-size: 0.85rem; color: #9ca3af; margin-bottom: 1.5rem; font-family: monospace; background: #f9fafb; display: inline-block; padding: 2px 8px; border-radius: 4px; }
        
        .clock-box { background: linear-gradient(145deg, #f3f4f6, #ffffff); border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: inset 5px 5px 10px #e1e2e4, inset -5px -5px 10px #ffffff; }
        .clock { font-size: 3.5rem; font-family: 'Courier New', monospace; font-weight: bold; color: #2563eb; letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .btn { padding: 1.2rem; border: none; border-radius: 15px; font-size: 1.1rem; font-weight: bold; color: white; cursor: pointer; transition: transform 0.1s, box-shadow 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.95); }
        .btn-in { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); } 
        .btn-in:hover { box-shadow: 0 6px 15px rgba(34, 197, 94, 0.4); }
        .btn-out { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .btn-out:hover { box-shadow: 0 6px 15px rgba(249, 115, 22, 0.4); }
        
        /* ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
        .status-area { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px dashed #e5e7eb; font-size: 0.95rem; color: #4b5563; }
        .status-title { font-weight: bold; margin-bottom: 10px; color: #374151; text-align: left; }
        .status-row { display: flex; justify-content: space-between; align-items: center; margin-top: 0.8rem; background: #f9fafb; padding: 10px 15px; border-radius: 10px; }
        .time-val { font-weight: bold; color: #111827; font-family: monospace; font-size: 1.1rem; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
        .btn-edit {
            background-color: white; border: 1px solid #d1d5db; color: #4b5563;
            font-size: 0.8rem; padding: 4px 10px; border-radius: 6px; cursor: pointer; margin-left: 10px; transition: all 0.2s;
        }
        .btn-edit:hover { background-color: #2563eb; color: white; border-color: #2563eb; }
    </style>

    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
</head>
<body>

    <div class="nav-bar">
        <a href="menu.html" class="back-btn">‚¨Ö ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
        <div class="user-display">
            üë§ <span id="userName">...</span>
        </div>
    </div>

    <div class="card">
        <div class="date-display" id="humanDate">-</div>
        <div class="db-date-format">Work Date: <span id="dbDateDisplay">-</span></div>
        
        <div class="clock-box">
            <div class="clock" id="clockDisplay">00:00:00</div>
        </div>

        <div class="btn-group">
            <button class="btn btn-in" onclick="recordTime('in')">üïí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</button>
            <button class="btn btn-out" onclick="recordTime('out')">üè† ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>
        </div>

        <div class="status-area">
            <div class="status-title">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏à‡∏≤‡∏Å DB)</div>
            
            <div class="status-row">
                <span>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤:</span>
                <div style="display: flex; align-items: center;">
                    <span id="timeInDisplay" class="time-val">-</span>
                    <button class="btn-edit" onclick="editTime('time_in')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </div>

            <div class="status-row">
                <span>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å:</span>
                <div style="display: flex; align-items: center;">
                    <span id="timeOutDisplay" class="time-val">-</span>
                    <button class="btn-edit" onclick="editTime('time_out')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = "https://tdcmbskmlrwhbjrjyjkk.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkY21ic2ttbHJ3aGJqcmp5amtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTY4NTYsImV4cCI6MjA3ODE5Mjg1Nn0.FeYe75J8X_2LoQgG_JWyPNCKcuCL_otsmSW0s5bijAg"; // ‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà Key
        
        let client = null;
        let userData = null;
        let currentRecord = null;

        const Toast = typeof Swal !== 'undefined' ? Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        }) : null;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á ID (YYYYMMDDHHmmss + ‡∏™‡∏∏‡πà‡∏° 4 ‡∏´‡∏•‡∏±‡∏Å)
        function generateID() {
            const now = new Date();
            const yy = String(now.getFullYear());
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            const r = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `${yy}${mm}${dd}${h}${m}${s}${r}`;
        }

        function init() {
            try {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Login
                const stored = localStorage.getItem('tas_user');
                if (!stored) { window.location.href = 'login.html'; return; }
                userData = JSON.parse(stored);

                // üîí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Level 1
                if (String(userData.level) !== '1') {
                    alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Level 1)');
                    window.location.href = 'menu.html';
                    return;
                }

                document.getElementById('userName').innerText = userData.name;

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Library
                if (typeof window.supabase === 'undefined' || typeof Swal === 'undefined') {
                    alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå supabase.js ‡∏´‡∏£‡∏∑‡∏≠ sweetalert2.js"); return;
                }
                
                client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                startClock();
                loadTodayRecord();

            } catch (e) {
                console.error(e); window.location.href = 'login.html';
            }
        }

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Local Time)
        function getDBFormatValues() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return {
                date: `${year}-${month}-${day}`, 
                time: `${hours}:${minutes}:${seconds}`, 
                obj: now
            };
        }

        function startClock() {
            setInterval(() => {
                const val = getDBFormatValues();
                document.getElementById('clockDisplay').innerText = val.time;
                document.getElementById('dbDateDisplay').innerText = val.date;
                document.getElementById('humanDate').innerText = val.obj.toLocaleDateString('th-TH', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
            }, 1000);
            const val = getDBFormatValues();
            document.getElementById('clockDisplay').innerText = val.time;
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å TimeStampPlus
        async function loadTodayRecord() {
            if (!client) return;
            const val = getDBFormatValues();
            try {
                const { data, error } = await client
                    .from('TimeStampPlus')
                    .select('*')
                    .eq('personnel_id', userData.personnel_id)
                    .eq('work_date', val.date)
                    .single();

                if (data) {
                    currentRecord = data;
                    document.getElementById('timeInDisplay').innerText = data.time_in || "-";
                    document.getElementById('timeOutDisplay').innerText = data.time_out || "-";
                } else {
                    currentRecord = null;
                    document.getElementById('timeInDisplay').innerText = "-";
                    document.getElementById('timeOutDisplay').innerText = "-";
                }
            } catch (err) {
                if (err.code !== 'PGRST116') console.error(err);
                currentRecord = null;
            }
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
        async function editTime(field) {
            if (!client) return;
            if (!currentRecord) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ', 'warning'); return;
            }

            const oldVal = field === 'time_in' ? currentRecord.time_in : currentRecord.time_out;
            const { value: newVal } = await Swal.fire({
                title: `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç${field === 'time_in' ? '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤' : '‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å'}`,
                input: 'time',
                inputLabel: '‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà (HH:MM:SS)',
                inputValue: oldVal || '08:00:00',
                inputAttributes: { step: 1 }, // üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÑ‡∏î‡πâ
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                confirmButtonColor: '#2563eb'
            });

            if (!newVal) return; 
            const timeToSave = newVal.length === 5 ? newVal + ":00" : newVal;

            try {
                const updateData = {}; updateData[field] = timeToSave;
                const { error } = await client.from('TimeStampPlus').update(updateData).eq('id', currentRecord.id);
                if (error) throw error;
                Toast.fire({ icon: 'success', title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
                loadTodayRecord();
            } catch (err) {
                Swal.fire('Error', err.message, 'error');
            }
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
        async function recordTime(type) {
            if (!client) return;
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤?',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${type === 'in' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' : '‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô'} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: type === 'in' ? '#22c55e' : '#f97316',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¢'
            });

            if (!result.isConfirmed) return;

            const val = getDBFormatValues();
            const newID = generateID();

            try {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
                await loadTodayRecord();
                let error = null;

                if (type === 'in') {
                    if (currentRecord) {
                        const { error: upError } = await client.from('TimeStampPlus').update({ time_in: val.time }).eq('id', currentRecord.id);
                        error = upError;
                    } else {
                        const { error: insError } = await client.from('TimeStampPlus').insert([{
                            id: newID, personnel_id: userData.personnel_id, full_name: userData.name,
                            work_date: val.date, time_in: val.time
                        }]);
                        error = insError;
                    }
                } else { 
                    if (currentRecord) {
                        const { error: upError } = await client.from('TimeStampPlus').update({ time_out: val.time }).eq('id', currentRecord.id);
                        error = upError;
                    } else {
                        const { error: insError } = await client.from('TimeStampPlus').insert([{
                            id: newID, personnel_id: userData.personnel_id, full_name: userData.name,
                            work_date: val.date, time_out: val.time
                        }]);
                        error = insError;
                    }
                }

                if (error) throw error;
                Toast.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' });
                loadTodayRecord();

            } catch (err) {
                console.error(err); Swal.fire('Error', err.message, 'error');
            }
        }

        init();
    </script>
</body>
</html>
