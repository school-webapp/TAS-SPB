<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô - TAS-SPB</title>
    
    <style>
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å */
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        
        /* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß */
        .header { width: 100%; max-width: 400px; display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 1rem; color: #4b5563; align-items: center; }
        .logout { color: #ef4444; cursor: pointer; text-decoration: none; border: 1px solid #ef4444; background: none; font-size: 0.85rem; padding: 5px 12px; border-radius: 20px; transition: all 0.3s; }
        .logout:hover { background-color: #ef4444; color: white; }
        
        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏•‡∏±‡∏Å */
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 100%; max-width: 400px; text-align: center; }
        
        /* ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ */
        .date-display { font-size: 1.2rem; color: #1f2937; margin-bottom: 0.5rem; font-weight: bold; }
        .db-date-format { font-size: 0.85rem; color: #9ca3af; margin-bottom: 1.5rem; font-family: monospace; background: #f9fafb; display: inline-block; padding: 2px 8px; border-radius: 4px; }
        
        .clock-box { background: linear-gradient(145deg, #f3f4f6, #ffffff); border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: inset 5px 5px 10px #e1e2e4, inset -5px -5px 10px #ffffff; }
        .clock { font-size: 3.5rem; font-family: 'Courier New', monospace; font-weight: bold; color: #2563eb; letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .btn { padding: 1.2rem; border: none; border-radius: 15px; font-size: 1.1rem; font-weight: bold; color: white; cursor: pointer; transition: transform 0.1s, box-shadow 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.95); }
        .btn-in { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); } 
        .btn-in:hover { box-shadow: 0 6px 15px rgba(34, 197, 94, 0.4); }
        .btn-out { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .btn-out:hover { box-shadow: 0 6px 15px rgba(249, 115, 22, 0.4); }
        
        /* ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
        .status-area { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px dashed #e5e7eb; font-size: 0.95rem; color: #4b5563; }
        .status-title { font-weight: bold; margin-bottom: 10px; color: #374151; text-align: left; }
        .status-row { display: flex; justify-content: space-between; align-items: center; margin-top: 0.8rem; background: #f9fafb; padding: 10px 15px; border-radius: 10px; }
        .time-val { font-weight: bold; color: #111827; font-family: monospace; font-size: 1.1rem; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç */
        .btn-edit {
            background-color: white; border: 1px solid #d1d5db; color: #4b5563;
            font-size: 0.8rem; padding: 4px 10px; border-radius: 6px; cursor: pointer; margin-left: 10px; transition: all 0.2s;
        }
        .btn-edit:hover { background-color: #2563eb; color: white; border-color: #2563eb; }
    </style>

    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
</head>
<body>

    <div class="header">
        <div>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="userName" style="color: #2563eb; font-weight: bold; font-size: 1.1rem;">...</span></div>
        <button class="logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="card">
        <div class="date-display" id="humanDate">-</div>
        <div class="db-date-format">Work Date: <span id="dbDateDisplay">-</span></div>
        
        <div class="clock-box">
            <div class="clock" id="clockDisplay">00:00:00</div>
        </div>

        <div class="btn-group">
            <button class="btn btn-in" onclick="recordTime('in')">üïí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</button>
            <button class="btn btn-out" onclick="recordTime('out')">üè† ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>
        </div>

        <div class="status-area">
            <div class="status-title">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏à‡∏≤‡∏Å DB)</div>
            
            <div class="status-row">
                <span>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤:</span>
                <div style="display: flex; align-items: center;">
                    <span id="timeInDisplay" class="time-val">-</span>
                    <button class="btn-edit" onclick="editTime('time_in')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </div>

            <div class="status-row">
                <span>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å:</span>
                <div style="display: flex; align-items: center;">
                    <span id="timeOutDisplay" class="time-val">-</span>
                    <button class="btn-edit" onclick="editTime('time_out')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase ---
        const SUPABASE_URL = "https://tdcmbskmlrwhbjrjyjkk.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkY21ic2ttbHJ3aGJqcmp5amtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTY4NTYsImV4cCI6MjA3ODE5Mjg1Nn0.FeYe75J8X_2LoQgG_JWyPNCKcuCL_otsmSW0s5bijAg";
        
        let client = null;
        let userData = null;
        let currentRecord = null;

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Toast Notification (‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô)
        const Toast = typeof Swal !== 'undefined' ? Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        }) : null;

        // üî• ‡∏™‡∏£‡πâ‡∏≤‡∏á ID (YYYYMMDDHHmmss + ‡∏™‡∏∏‡πà‡∏° 4 ‡∏´‡∏•‡∏±‡∏Å) -> ‡∏£‡∏ß‡∏° 18 ‡∏´‡∏•‡∏±‡∏Å (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 20)
        function generateID() {
            const now = new Date();
            const yy = String(now.getFullYear());
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            const r = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `${yy}${mm}${dd}${h}${m}${s}${r}`;
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        function init() {
            try {
                // ‡πÄ‡∏ä‡πá‡∏Ñ Login
                const stored = localStorage.getItem('tas_user');
                if (!stored) {
                    window.location.href = 'login.html';
                    return;
                }
                userData = JSON.parse(stored);
                document.getElementById('userName').innerText = userData.name || userData.personnel_id;

                // ‡πÄ‡∏ä‡πá‡∏Ñ Library
                if (typeof window.supabase === 'undefined' || typeof Swal === 'undefined') {
                    alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå supabase.js ‡∏´‡∏£‡∏∑‡∏≠ sweetalert2.js ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå");
                    return;
                }
                
                // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ DB
                client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                startClock();
                loadTodayRecord();

            } catch (e) {
                console.error(e);
                window.location.href = 'login.html';
            }
        }

        // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (Local Time)
        function getDBFormatValues() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            return {
                date: `${year}-${month}-${day}`, // YYYY-MM-DD
                time: `${hours}:${minutes}:${seconds}`, // HH:MM:SS
                obj: now
            };
        }

        function startClock() {
            setInterval(() => {
                const val = getDBFormatValues();
                document.getElementById('clockDisplay').innerText = val.time;
                document.getElementById('dbDateDisplay').innerText = val.date;
                document.getElementById('humanDate').innerText = val.obj.toLocaleDateString('th-TH', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
            }, 1000);
            
            const val = getDBFormatValues();
            document.getElementById('clockDisplay').innerText = val.time;
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        async function loadTodayRecord() {
            if (!client) return;
            const val = getDBFormatValues();
            const todayDB = val.date;

            try {
                const { data, error } = await client
                    .from('TimeStampPlus')
                    .select('*')
                    .eq('personnel_id', userData.personnel_id)
                    .eq('work_date', todayDB)
                    .single();

                if (data) {
                    currentRecord = data;
                    document.getElementById('timeInDisplay').innerText = data.time_in || "-";
                    document.getElementById('timeOutDisplay').innerText = data.time_out || "-";
                    return data;
                } else {
                    currentRecord = null;
                    document.getElementById('timeInDisplay').innerText = "-";
                    document.getElementById('timeOutDisplay').innerText = "-";
                    return null;
                }
            } catch (err) {
                // PGRST116 ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥)
                if (err.code !== 'PGRST116') console.error(err);
                currentRecord = null;
                return null;
            }
        }

        // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤ (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà: step=1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
        async function editTime(field) {
            if (!client) return;
            
            if (!currentRecord) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ', 'warning');
                return;
            }

            const oldVal = field === 'time_in' ? currentRecord.time_in : currentRecord.time_out;
            const labelText = field === 'time_in' ? '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤' : '‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å';

            // Popup ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
            const { value: newVal } = await Swal.fire({
                title: `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç${labelText}`,
                input: 'time',
                inputLabel: '‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà (HH:MM:SS)',
                inputValue: oldVal || '08:00:00',
                // üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: step 1 ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà error
                inputAttributes: {
                    step: 1
                },
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#2563eb'
            });

            if (!newVal) return; 

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö HH:MM ‡∏´‡∏£‡∏∑‡∏≠ HH:MM:SS
            const timeToSave = newVal.length === 5 ? newVal + ":00" : newVal;

            try {
                const updateData = {};
                updateData[field] = timeToSave;

                const { error } = await client
                    .from('TimeStampPlus')
                    .update(updateData)
                    .eq('id', currentRecord.id);

                if (error) throw error;

                Toast.fire({ icon: 'success', title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
                loadTodayRecord();

            } catch (err) {
                console.error(err);
                Swal.fire('Error', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
            }
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å)
        async function recordTime(type) {
            if (!client) return;

            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤?',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${type === 'in' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' : '‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô'} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: type === 'in' ? '#22c55e' : '#f97316',
                cancelButtonColor: '#d33',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (!result.isConfirmed) return;

            const val = getDBFormatValues();
            const todayDB = val.date;
            const timeDB = val.time; 
            const newID = generateID();

            try {
                const existing = await loadTodayRecord();
                let error = null;

                if (type === 'in') {
                    if (existing) {
                        // ‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß -> Update
                        const { error: upError } = await client.from('TimeStampPlus').update({ time_in: timeDB }).eq('id', existing.id);
                        error = upError;
                    } else {
                        // ‡πÉ‡∏´‡∏°‡πà -> Insert (‡πÉ‡∏™‡πà ID ‡πÄ‡∏≠‡∏á + ‡∏ï‡∏±‡∏î verified)
                        const { error: insError } = await client.from('TimeStampPlus').insert([{ id: newID, personnel_id: userData.personnel_id, full_name: userData.name, work_date: todayDB, time_in: timeDB }]);
                        error = insError;
                    }
                } else { 
                    if (existing) {
                        // ‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß -> Update
                        const { error: upError } = await client.from('TimeStampPlus').update({ time_out: timeDB }).eq('id', existing.id);
                        error = upError;
                    } else {
                        // ‡πÉ‡∏´‡∏°‡πà (‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤) -> Insert
                        const { error: insError } = await client.from('TimeStampPlus').insert([{ id: newID, personnel_id: userData.personnel_id, full_name: userData.name, work_date: todayDB, time_out: timeDB }]);
                        error = insError;
                    }
                }

                if (error) throw error;

                Toast.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' });
                loadTodayRecord();

            } catch (err) {
                console.error(err);
                Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
            }
        }

        function logout() {
            Swal.fire({
                title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: '‡∏≠‡∏≠‡∏Å',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('tas_user');
                    window.location.href = 'login.html';
                }
            });
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        init();
    </script>
</body>
</html>
