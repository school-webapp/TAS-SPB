<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAS-SPB Management System</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>

    <style>
        :root {
            --primary: #ec4899; --bg: #f3f4f6; --text: #1f2937;
            --muted: #6b7280; --border: #e5e7eb; --success: #10b981; --danger: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); color: var(--text); padding: 15px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .container { max-width: 800px; margin: 0 auto; width: 100%; height: 100%; display: flex; flex-direction: column; }

        /* Header & Tabs */
        .card-header { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 12px; border-bottom: 4px solid var(--primary); }
        .tabs { display: flex; background: #fdf2f8; padding: 5px; border-radius: 15px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; border-radius: 10px; cursor: pointer; font-weight: 700; color: var(--muted); font-family: 'Sarabun'; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* Sub-controls inside sections */
        .controls-area { margin-bottom: 10px; }
        .sub-tabs { display: flex; gap: 8px; margin-bottom: 10px; }
        .sub-btn { flex: 1; padding: 10px; border: 1.5px solid var(--border); background: white; border-radius: 10px; cursor: pointer; font-size: 0.85rem; font-weight: bold; color: var(--muted); font-family: 'Sarabun'; }
        .sub-btn.active { border-color: var(--primary); color: var(--primary); background: #fff1f2; }

        /* Dynamic Content Area */
        .content-scroll { flex: 1; overflow-y: hidden; display: flex; flex-direction: column; }
        .data-list { display: grid; gap: 8px; align-content: start; }
        
        .data-item { 
            background: white; padding: 12px 15px; border-radius: 15px; border-left: 5px solid #ccc; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); height: 70px; /* Fixed height for dynamic calc */
        }
        .item-att { border-left-color: var(--primary); }
        .item-leave { border-left-color: #f59e0b; }
        .item-person { border-left-color: #6b7280; }

        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; display: inline-block; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        
        .date-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 10px; font-family: 'Sarabun'; margin-bottom: 8px; background: #fff; }
        
        /* Pager UI */
        .pager { display: flex; justify-content: center; align-items: center; gap: 20px; padding: 15px 0; background: var(--bg); }
        .btn-page { width: 40px; height: 40px; border-radius: 12px; border: 1px solid var(--border); background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-page:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .btn-icon { width: 36px; height: 36px; border-radius: 10px; border: none; background: #f3f4f6; color: var(--muted); cursor: pointer; margin-left: 4px; }
        .fab { position: fixed; bottom: 85px; right: 20px; width: 60px; height: 60px; background: var(--success); color: white; border-radius: 50%; border: none; font-size: 1.5rem; box-shadow: 0 4px 12px rgba(16,185,129,0.4); cursor: pointer; z-index: 100; }
    </style>
</head>
<body>

<div class="container">
    <div class="card-header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><h2 style="font-size:1.1rem; color:var(--text);">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö TAS-SPB</h2><p style="font-size:0.75rem; color:var(--muted);">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÇ‡∏´‡∏°‡∏î</p></div>
            <a href="menu.html" style="color:var(--primary); text-decoration:none;"><i class="fas fa-home fa-lg"></i></a>
        </div>
    </div>

    <div class="tabs">
        <button id="tab-att-btn" class="tab-btn active" onclick="changeTab('att')">üïí ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>
        <button id="tab-leave-btn" class="tab-btn" onclick="changeTab('leave')">‚úàÔ∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏≤</button>
        <button id="tab-person-btn" class="tab-btn" onclick="changeTab('person')">üë• ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</button>
    </div>

    <div class="content-scroll" id="main-content">
        <div id="section-att" class="content-section">
            <div class="controls-area">
                <input type="date" id="attDate" class="date-input" onchange="resetPage('att')">
                <div class="sub-tabs">
                    <button class="sub-btn active" id="att-sub-all" onclick="setAttSub('all')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button class="sub-btn" id="att-sub-inc" onclick="setAttSub('inc')">‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</button>
                </div>
            </div>
            <div id="list-att" class="data-list"></div>
        </div>

        <div id="section-leave" class="content-section" style="display:none;">
            <div class="controls-area">
                <div class="sub-tabs">
                    <button class="sub-btn active" id="leave-sub-all" onclick="setLeaveSub('all')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button class="sub-btn" id="leave-sub-date" onclick="setLeaveSub('date')">‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                </div>
                <div id="leave-date-area" style="display:none;">
                    <input type="date" id="leaveDate" class="date-input" onchange="resetPage('leave')">
                </div>
            </div>
            <div id="list-leave" class="data-list"></div>
        </div>

        <div id="section-person" class="content-section" style="display:none;">
            <div id="list-person" class="data-list"></div>
        </div>
    </div>

    <div class="pager" id="pager-controls">
        <button class="btn-page" id="prevBtn" onclick="movePage(-1)"><i class="fas fa-chevron-left"></i></button>
        <span id="pageInfo" style="font-weight:bold; font-size:0.9rem; color:var(--muted);">‡∏´‡∏ô‡πâ‡∏≤ 1 / 1</span>
        <button class="btn-page" id="nextBtn" onclick="movePage(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<button class="fab" onclick="handleAdd()"><i class="fas fa-plus"></i></button>

<script>
    let currentTab = 'att';
    let filters = { att: 'all', leave: 'all' };
    let pages = { att: 1, leave: 1, person: 1 };
    let personnelMap = {};
    let currentTotalCount = 0;

    // --- Dynamic Page Size Calculation ---
    function getPageSize() {
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á Card Item (70px + 8px gap)
        const contentHeight = document.getElementById('main-content').clientHeight;
        const controlsHeight = document.querySelector(`#section-${currentTab} .controls-area`)?.clientHeight || 0;
        const availableHeight = contentHeight - controlsHeight;
        const size = Math.floor(availableHeight / 78); 
        return size > 0 ? size : 5;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('attDate').value = today;
        document.getElementById('leaveDate').value = today;
        await loadPersonnelMap();
        render();
        window.addEventListener('resize', render); // Recalculate size on window resize
    });

    async function loadPersonnelMap() {
        const { data } = await sbClient.from('Personnel').select('personnel_id, name');
        data?.forEach(p => personnelMap[p.personnel_id] = p.name);
    }

    // Helper: ‡∏ß‡∏ß/‡∏î‡∏î/‡∏õ‡∏õ‡∏õ‡∏õ
    function fmtDate(d) {
        if(!d) return '';
        const date = new Date(d);
        return date.toLocaleDateString('th-TH', {day:'2-digit', month:'2-digit', year:'numeric'});
    }

    function changeTab(t) {
        currentTab = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${t}-btn`).classList.add('active');
        document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
        document.getElementById(`section-${t}`).style.display = 'block';
        render();
    }

    function resetPage(t) { pages[t] = 1; render(); }
    function movePage(step) { 
        const max = Math.ceil(currentTotalCount / getPageSize());
        const next = pages[currentTab] + step;
        if(next >= 1 && next <= max) { pages[currentTab] = next; render(); }
    }

    function setAttSub(s) { 
        filters.att = s; 
        document.getElementById('att-sub-all').className = s==='all'?'sub-btn active':'sub-btn';
        document.getElementById('att-sub-inc').className = s==='inc'?'sub-btn active':'sub-btn';
        resetPage('att'); 
    }

    function setLeaveSub(s) { 
        filters.leave = s; 
        document.getElementById('leave-sub-all').className = s==='all'?'sub-btn active':'sub-btn';
        document.getElementById('leave-sub-date').className = s==='date'?'sub-btn active':'sub-btn';
        document.getElementById('leave-date-area').style.display = s==='date'?'block':'none';
        resetPage('leave'); 
    }

    async function render() {
        const size = getPageSize();
        const start = (pages[currentTab]-1) * size;
        const end = start + size - 1;

        if(currentTab === 'att') await renderAtt(start, end);
        else if(currentTab === 'leave') await renderLeave(start, end);
        else await renderPerson(start, end);
        
        // Update Pager UI
        const max = Math.ceil(currentTotalCount / size) || 1;
        document.getElementById('pageInfo').innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${pages[currentTab]} / ${max}`;
        document.getElementById('prevBtn').disabled = pages[currentTab] === 1;
        document.getElementById('nextBtn').disabled = pages[currentTab] >= max;
    }

    async function renderAtt(s, e) {
        const date = document.getElementById('attDate').value;
        const container = document.getElementById('list-att');
        let query = sbClient.from('TimeStamp').select('*', {count:'exact'}).eq('work_date', date);
        if(filters.att === 'inc') query = query.or('time_in.is.null,time_out.is.null');
        
        const { data, count } = await query.order('time_in', {ascending:true}).range(s, e);
        currentTotalCount = count || 0;
        
        container.innerHTML = data?.map(r => `
            <div class="data-item item-att">
                <div>
                    <strong>${personnelMap[r.personnel_id] || r.full_name || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å'}</strong>
                    <div style="margin-top:4px;">
                        <span class="badge ${r.time_in?'bg-green':'bg-red'}">IN: ${r.time_in?.slice(0,5)||'--:--'}</span>
                        <span class="badge ${r.time_out?'bg-green':'bg-red'}">OUT: ${r.time_out?.slice(0,5)||'--:--'}</span>
                    </div>
                </div>
                <div>
                    <button class="btn-icon" onclick="editAtt('${r.id}','${r.time_in}','${r.time_out}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-icon" onclick="delRec('TimeStamp','${r.id}')"><i class="fas fa-trash text-danger"></i></button>
                </div>
            </div>
        `).join('') || '<center style="padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>';
    }

    async function renderLeave(s, e) {
        const container = document.getElementById('list-leave');
        let query = sbClient.from('Leave_records').select('*', {count:'exact'});
        if(filters.leave === 'date') query = query.eq('leave_date', document.getElementById('leaveDate').value);

        const { data, count } = await query.order('leave_date', {ascending:false}).range(s, e);
        currentTotalCount = count || 0;

        container.innerHTML = data?.map(r => `
            <div class="data-item item-leave">
                <div>
                    <small style="color:var(--primary); font-weight:bold;">üìÖ ${fmtDate(r.leave_date)}</small><br>
                    <strong>${personnelMap[r.personnel_id] || r.personnel_id}</strong>
                    <span class="badge" style="background:#fff7ed; color:#c2410c; margin-left:5px;">${r.leave_type}</span>
                </div>
                <div>
                    <button class="btn-icon" onclick="editLeave('${r.id}','${r.leave_date}','${r.leave_type}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-icon" onclick="delRec('Leave_records','${r.id}')"><i class="fas fa-trash text-danger"></i></button>
                </div>
            </div>
        `).join('') || '<center style="padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>';
    }

    async function renderPerson(s, e) {
        const container = document.getElementById('list-person');
        const { data, count } = await sbClient.from('Personnel').select('*', {count:'exact'}).order('personnel_id').range(s, e);
        currentTotalCount = count || 0;
        
        container.innerHTML = data?.map(p => `
            <div class="data-item item-person">
                <div><strong>${p.name}</strong><br><small style="color:var(--muted)">‡∏£‡∏´‡∏±‡∏™: ${p.personnel_id}</small></div>
                <div>
                    <button class="btn-icon" onclick="editPerson('${p.personnel_id}','${p.name}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-icon" onclick="delRec('Personnel','${p.personnel_id}','personnel_id')"><i class="fas fa-trash text-danger"></i></button>
                </div>
            </div>
        `).join('') || '<center style="padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</center>';
    }

    // --- CRUD POPUPS ---
    async function delRec(tbl, id, col='id') {
        const res = await Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?', text: "‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' });
        if(res.isConfirmed) {
            await sbClient.from(tbl).delete().eq(col, id);
            if(tbl === 'Personnel') await loadPersonnelMap();
            render();
        }
    }

    async function editAtt(id, tin, tout) {
        const { value: f } = await Swal.fire({
            title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',
            html: `‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤: <input id="sw-in" type="time" class="swal2-input" value="${tin?.slice(0,5)||''}">
                   ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å: <input id="sw-out" type="time" class="swal2-input" value="${tout?.slice(0,5)||''}">`,
            preConfirm: () => ({ time_in: document.getElementById('sw-in').value || null, time_out: document.getElementById('sw-out').value || null })
        });
        if(f) { await sbClient.from('TimeStamp').update(f).eq('id', id); render(); }
    }

    async function editLeave(id, date, type) {
        const { value: f } = await Swal.fire({
            title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏•‡∏≤',
            html: `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <input id="sw-date" type="date" class="swal2-input" value="${date}">
                   ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: <select id="sw-type" class="swal2-input"><option value="‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢" ${type==='‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'?'selected':''}>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option><option value="‡∏•‡∏≤‡∏Å‡∏¥‡∏à" ${type==='‡∏•‡∏≤‡∏Å‡∏¥‡∏à'?'selected':''}>‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option><option value="‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô" ${type==='‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô'?'selected':''}>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</option></select>`,
            preConfirm: () => ({ leave_date: document.getElementById('sw-date').value, leave_type: document.getElementById('sw-type').value })
        });
        if(f) { await sbClient.from('Leave_records').update(f).eq('id', id); render(); }
    }

    async function editPerson(id, name) {
        const { value: n } = await Swal.fire({
            title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
            input: 'text', inputValue: name,
            preConfirm: (val) => val || Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠')
        });
        if(n) { await sbClient.from('Personnel').update({name: n}).eq('personnel_id', id); await loadPersonnelMap(); render(); }
    }

    async function handleAdd() {
        if(currentTab === 'person') {
            const { value: f } = await Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
                html: `<input id="sw-pid" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" class="swal2-input"><input id="sw-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="swal2-input">`,
                preConfirm: () => ({ personnel_id: document.getElementById('sw-pid').value, name: document.getElementById('sw-name').value })
            });
            if(f && f.personnel_id) { await sbClient.from('Personnel').insert([f]); await loadPersonnelMap(); render(); }
        } else if(currentTab === 'leave') {
            const psList = Object.entries(personnelMap).map(([id, name]) => `<option value="${id}">${name}</option>`).join('');
            const { value: f } = await Swal.fire({
                title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏≤',
                html: `<select id="sw-pid" class="swal2-input">${psList}</select>
                       <input id="sw-date" type="date" class="swal2-input" value="${new Date().toISOString().split('T')[0]}">
                       <select id="sw-type" class="swal2-input"><option>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option><option>‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option><option>‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</option></select>`,
                preConfirm: () => ({ id: Date.now().toString(), personnel_id: document.getElementById('sw-pid').value, leave_date: document.getElementById('sw-date').value, leave_type: document.getElementById('sw-type').value, status:'approved', approved_by: user.name || 'Admin' })
            });
            if(f && f.leave_type) { await sbClient.from('Leave_records').insert([f]); render(); }
        }
    }
</script>
</body>
</html>
