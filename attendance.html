<div id="filter-container" class="filter-status" style="display:none; margin-bottom: 15px;">
    <button id="filter-all" class="btn-filter bg-green active" onclick="setStatusFilter('all')">
        <i class="fas fa-list"></i> ทั้งหมด
    </button>
    <button id="filter-incomplete" class="btn-filter bg-gray" onclick="setStatusFilter('incomplete')">
        <i class="fas fa-exclamation-triangle"></i> ลงเวลาไม่สมบูรณ์
    </button>
</div>

<script>
    async function loadAttendance() {
        const date = document.getElementById('filterDate').value;
        const container = document.getElementById('list-att');
        const filterContainer = document.getElementById('filter-container'); // เพิ่มตัวแปรอ้างอิง Filter

        container.innerHTML = `<div style="text-align:center; padding:20px; color:#4f46e5;">⏳ กำลังโหลดเวลา...</div>`;
        
        try {
            // สร้าง Query พื้นฐาน (ยังไม่กรอง incomplete เพื่อเช็คจำนวนทั้งหมดก่อน)
            let query = sbClient.from(TAS_CONFIG.TABLE_TARGET).select('*').eq('work_date', date);
            
            // ถ้าผู้ใช้กดเลือกตัวกรอง incomplete ให้เพิ่มเงื่อนไข
            if (statusFilter === 'incomplete') {
                query = query.or('time_in.is.null,time_out.is.null');
            }
            
            const { data, error } = await query.order('time_in');
            
            if (error) throw error;

            // --- ส่วนสำคัญ: เช็คการแสดงตัวกรอง ---
            if (!data || data.length === 0) { 
                // ถ้าไม่มีข้อมูลในวันที่เลือกเลย ให้ซ่อนตัวกรอง (ยกเว้นกรณีที่กรอง incomplete แล้วไม่เจอ ให้ดูจากสถานะเริ่มต้น)
                if (statusFilter === 'all') {
                    filterContainer.style.display = 'none';
                    container.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">ไม่พบข้อมูลเวลาทำงานในวันนี้</div>`; 
                } else {
                    // กรณีเปิดตัวกรองไว้แต่ไม่พบรายการที่เข้าเงื่อนไข (เช่น ทุกคนลงเวลาครบ)
                    filterContainer.style.display = 'flex';
                    container.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">ไม่พบรายการที่ลงเวลาไม่สมบูรณ์</div>`;
                }
                return; 
            }

            // ถ้ามีข้อมูล ให้แสดงตัวกรอง
            filterContainer.style.display = 'flex';
            
            // แสดงรายการข้อมูลตามปกติ
            container.innerHTML = data.map(r => `
            <div class="data-item item-att">
                <div class="info">
                    <h4>${r.full_name || personnelMap[r.personnel_id] || r.personnel_id}</h4>
                    <p>
                        <span class="badge ${r.time_in ? 'bg-green' : 'bg-red'}">เข้า: ${r.time_in ? r.time_in.slice(0, 5) : 'ขาด'}</span>
                        <span class="badge ${r.time_out ? 'bg-green' : 'bg-red'}">ออก: ${r.time_out ? r.time_out.slice(0, 5) : 'ขาด'}</span>
                        <small>(${r.personnel_id})</small>
                    </p>
                </div>
                <div class="actions">
                    <button class="btn-icon btn-edit" onclick="editAtt('${r.id}', '${r.full_name}', '${r.time_in || ''}', '${r.time_out || ''}')"><i class="fas fa-pen"></i></button>
                    <button class="btn-icon btn-del" onclick="delAtt('${r.id}')"><i class="fas fa-trash"></i></button>
                </div>
            </div>`).join('');

        } catch (err) { 
            filterContainer.style.display = 'none';
            container.innerHTML = `<div style="text-align:center; color:red;">โหลดไม่สำเร็จ: ${err.message}</div>`; 
        }
    }

    // อย่าลืมแก้ไขฟังก์ชัน switchTab เพื่อซ่อน Filter เมื่อไปแท็บ "การลา"
    window.switchTab = function (tabName) {
        currentTab = tabName;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-tab-${tabName}`).classList.add('active');
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        // ถ้าไม่อยู่หน้า 'att' ให้ซ่อน Filter เสมอ
        if (tabName !== 'att') {
            document.getElementById('filter-container').style.display = 'none';
        } else {
            // ถ้ากลับมาหน้า 'att' ให้โหลดใหม่เพื่อเช็คสถานะการแสดง Filter
            loadAttendance();
        }
    }
</script>
