<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤ (Level 1) - TAS-SPB</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; padding: 20px; color: #1e293b; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: #64748b; font-weight: bold; background: #f8fafc; padding: 8px 15px; border-radius: 20px; border: 1px solid #e2e8f0; }
        .toolbar { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; align-items: end; background: #f8fafc; padding: 15px; border-radius: 8px; }
        .form-group { display: flex; flex-direction: column; }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-family: 'Sarabun'; }
        
        .btn { border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: #3b82f6; } .btn-success { background: #10b981; } .btn-warning { background: #f59e0b; } .btn-danger { background: #ef4444; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background-color: #e2e8f0; font-weight: 600; white-space: nowrap; }
        tr:hover { background-color: #f8fafc; }
        
        /* üî• CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Search Dropdown ‡πÉ‡∏ô Modal */
        .search-container { position: relative; width: 100%; }
        .search-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #cbd5e1; border-radius: 6px;
            max-height: 150px; overflow-y: auto; z-index: 9999;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none;
        }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        .search-item:hover { background-color: #e0f2fe; color: #0284c7; }
        .modal-form { display: grid; gap: 15px; text-align: left; }
        .readonly-input { background-color: #f1f5f9; color: #64748b; cursor: not-allowed; }
    </style>

    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>
</head>
<body>

    <div class="container">
        <div class="header">
            <h2>üõ†Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (TimeStampPlus)</h2>
            <a href="menu.html" class="back-btn">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
        </div>

        <div class="toolbar">
            <div class="form-group">
                <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</label>
                <input type="date" id="filterDate">
            </div>
            <button class="btn btn-primary" onclick="loadData()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            <div style="flex-grow: 1;"></div>
            <button class="btn btn-success" onclick="openAddModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
        </div>

        <div style="overflow-x: auto;">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th>‡∏£‡∏´‡∏±‡∏™</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th>‡πÄ‡∏Ç‡πâ‡∏≤</th>
                        <th>‡∏≠‡∏≠‡∏Å</th>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th style="text-align:center;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="6" style="text-align:center;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ---
        if (typeof sbClient === 'undefined') {
            Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase (check config.js)', 'error');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö DB
        function getDBDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('filterDate').value = getDBDateString();
            loadData();
        });

        // --- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
        async function loadData() {
            const date = document.getElementById('filterDate').value;
            const tbody = document.getElementById('tableBody');
            
            if(!date) return;
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>';

            try {
                const { data, error } = await sbClient
                    .from(TAS_CONFIG.TABLE_SOURCE) 
                    .select('*')
                    .eq('work_date', date)
                    .order('time_in', { ascending: true });

                if (error) throw error;

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#64748b;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDateThai(date)}</td></tr>`;
                    return;
                }

                let html = '';
                data.forEach(row => {
                    const tIn = row.time_in ? row.time_in.substring(0, 5) : '-';
                    const tOut = row.time_out ? row.time_out.substring(0, 5) : '-';
                    
                    html += `
                        <tr>
                            <td>${row.personnel_id || ''}</td>
                            <td>${row.full_name || ''}</td>
                            <td style="color:green; font-weight:bold;">${tIn}</td>
                            <td style="color:red; font-weight:bold;">${tOut}</td>
                            <td>${formatDateThai(row.work_date)}</td>
                            <td style="text-align:center;">
                                <button class="btn btn-warning" style="padding:5px 10px; font-size:0.8rem;" onclick="openEditModal('${row.id}', '${row.personnel_id}', '${row.full_name}', '${tIn}', '${tOut}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger" style="padding:5px 10px; font-size:0.8rem;" onclick="deleteRecord('${row.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;

            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="6" style="color:red;text-align:center;">Error: ${err.message}</td></tr>`;
            }
        }

        // --- üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Real-time Search ---
        async function openAddModal() {
            const curDate = document.getElementById('filterDate').value;
            
            await Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Manual)',
                html: `
                    <div class="modal-form">
                        <div class="search-container">
                            <label>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                            <input id="search-box" class="swal2-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." autocomplete="off">
                            <div id="search-results" class="search-results"></div>
                        </div>

                        <div style="display:flex; gap:10px;">
                            <div style="flex:1">
                                <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                                <input id="swal-pid" class="swal2-input readonly-input" readonly>
                            </div>
                            <div style="flex:2">
                                <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</label>
                                <input id="swal-name" class="swal2-input readonly-input" readonly>
                            </div>
                        </div>
                        
                        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input type="date" id="swal-date" class="swal2-input" value="${curDate}">
                        
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1"><label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤:</label><input type="time" id="swal-in" class="swal2-input"></div>
                            <div style="flex:1"><label>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å:</label><input type="time" id="swal-out" class="swal2-input"></div>
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                
                // üî• Logic ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
                didOpen: () => {
                    const searchBox = Swal.getPopup().querySelector('#search-box');
                    const resultsBox = Swal.getPopup().querySelector('#search-results');
                    const pidInput = Swal.getPopup().querySelector('#swal-pid');
                    const nameInput = Swal.getPopup().querySelector('#swal-name');

                    searchBox.addEventListener('input', async (e) => {
                        const keyword = e.target.value.trim();
                        if (keyword.length < 2) { 
                            resultsBox.style.display = 'none'; 
                            return; 
                        }

                        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á Personnel
                        const { data } = await sbClient
                            .from('Personnel')
                            .select('personnel_id, name')
                            .ilike('name', `%${keyword}%`) // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥
                            .limit(5);

                        resultsBox.innerHTML = '';
                        if (data && data.length > 0) {
                            resultsBox.style.display = 'block';
                            data.forEach(p => {
                                const item = document.createElement('div');
                                item.className = 'search-item';
                                item.innerText = `${p.name} (${p.personnel_id})`;
                                
                                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                                item.onclick = () => {
                                    pidInput.value = p.personnel_id;
                                    nameInput.value = p.name;
                                    searchBox.value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                                    resultsBox.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                };
                                resultsBox.appendChild(item);
                            });
                        } else {
                            resultsBox.style.display = 'none';
                        }
                    });
                },
                preConfirm: () => {
                    const pid = document.getElementById('swal-pid').value;
                    const date = document.getElementById('swal-date').value;
                    if (!pid) return Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
                    if (!date) return Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
                    
                    return {
                        pid: pid,
                        name: document.getElementById('swal-name').value,
                        date: date,
                        in: document.getElementById('swal-in').value,
                        out: document.getElementById('swal-out').value
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const f = result.value;
                    await saveData(f);
                }
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á TimeStampPlus
        async function saveData(f) {
            try {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID 18 ‡∏´‡∏•‡∏±‡∏Å
                const newID = generateLongID();

                const { error } = await sbClient.from(TAS_CONFIG.TABLE_SOURCE).insert([{
                    id: newID,
                    personnel_id: f.pid,
                    full_name: f.name,
                    work_date: f.date,
                    time_in: f.in || null,
                    time_out: f.out || null
                }]);

                if (error) throw error;
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                loadData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            } catch (err) {
                Swal.fire('Error', err.message, 'error');
            }
        }

        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Edit) ---
        async function openEditModal(id, pid, name, tIn, tOut) {
            tIn = (tIn === '-') ? '' : tIn;
            tOut = (tOut === '-') ? '' : tOut;

            const { value: f } = await Swal.fire({
                title: `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${name}`,
                html: `
                    <div class="modal-form">
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1"><label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</label><input type="time" id="edit-in" class="swal2-input" value="${tIn}"></div>
                            <div style="flex:1"><label>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</label><input type="time" id="edit-out" class="swal2-input" value="${tOut}"></div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï',
                preConfirm: () => ({
                    in: document.getElementById('edit-in').value,
                    out: document.getElementById('edit-out').value
                })
            });

            if (f) {
                try {
                    const { error } = await sbClient.from(TAS_CONFIG.TABLE_SOURCE)
                        .update({ time_in: f.in || null, time_out: f.out || null })
                        .eq('id', id);

                    if (error) throw error;
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    loadData();
                } catch (err) {
                    Swal.fire('Error', err.message, 'error');
                }
            }
        }

        // --- ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
        function deleteRecord(id) {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const { error } = await sbClient.from(TAS_CONFIG.TABLE_SOURCE).delete().eq('id', id);
                    if (!error) {
                        loadData();
                        Swal.fire('Deleted!', '‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                    } else {
                        Swal.fire('Error', error.message, 'error');
                    }
                }
            })
        }

        // Helper
        function formatDateThai(dateStr) {
            if(!dateStr) return "-";
            const d = new Date(dateStr);
            return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear() + 543}`;
        }

        function generateLongID() {
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const r = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}${r}`;
        }
    </script>
</body>
</html>
