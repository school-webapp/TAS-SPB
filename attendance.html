<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤ (Level 1) - TAS-SPB</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #3b82f6; --primary-dark: #2563eb;
            --success: #10b981; --success-dark: #059669;
            --danger: #ef4444; --danger-dark: #dc2626;
            --warning: #f59e0b; --bg: #f8fafc; --card: #ffffff;
            --text: #334155; --border: #e2e8f0;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; }

        /* Container */
        .container {
            max-width: 1200px; margin: 0 auto;
            background: var(--card); padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        /* Header */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 15px; border-bottom: 2px solid var(--border);
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        .header h2 { margin: 0; font-size: 1.5rem; color: var(--primary); }
        .back-btn {
            text-decoration: none; color: #64748b; font-weight: bold;
            background: #f1f5f9; padding: 8px 16px; border-radius: 30px;
            transition: 0.2s; font-size: 0.9rem; white-space: nowrap;
        }
        
        /* Toolbar */
        .toolbar {
            display: flex; gap: 15px; flex-wrap: wrap;
            background: #f8fafc; padding: 15px; border-radius: 12px;
            border: 1px solid var(--border); margin-bottom: 20px;
            align-items: flex-end;
        }
        .form-group { display: flex; flex-direction: column; flex: 1; min-width: 200px; }
        .form-group label { font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; color: #475569; }
        
        input, select {
            padding: 10px 12px; border: 1px solid #cbd5e1;
            border-radius: 8px; font-family: 'Sarabun'; font-size: 1rem;
            width: 100%; transition: border-color 0.2s;
        }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* Buttons */
        .btn {
            border: none; padding: 10px 20px; border-radius: 8px;
            cursor: pointer; font-weight: 600; color: white; font-size: 1rem;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.2s; white-space: nowrap; height: 42px;
        }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); }
        .btn-danger { background: var(--danger); }
        .btn:active { transform: scale(0.98); }

        /* Table */
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background-color: #f1f5f9; color: #475569; font-weight: 600; white-space: nowrap; }
        tr:hover { background-color: #f8fafc; }

        /* Modal Styles */
        .modal-body { display: flex; flex-direction: column; gap: 15px; text-align: left; }
        .row-flex { display: flex; gap: 10px; }
        .readonly-input { background-color: #f1f5f9; color: #64748b; cursor: not-allowed; }
        
        /* Search Dropdown */
        .search-container { position: relative; }
        .search-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid var(--primary);
            border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto;
            z-index: 10000; box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            display: none;
        }
        .search-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        .search-item:hover { background-color: #eff6ff; color: var(--primary); font-weight: bold; }

        /* Modal Action Buttons */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .btn-action {
            padding: 15px; border: none; border-radius: 10px;
            font-size: 1.1rem; font-weight: bold; color: white;
            cursor: pointer; display: flex; flex-direction: column;
            align-items: center; gap: 5px; transition: 0.2s;
        }
        .btn-in { background: linear-gradient(145deg, #10b981, #059669); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
        .btn-out { background: linear-gradient(145deg, #ef4444, #dc2626); box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); }
        .btn-action:active { transform: translateY(2px); box-shadow: none; }

        /* üì± Responsive Adjustments */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            .header { flex-direction: column; align-items: flex-start; }
            .header h2 { font-size: 1.3rem; }
            .back-btn { margin-left: auto; } /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤‡∏™‡∏∏‡∏î */
            
            .toolbar { flex-direction: column; align-items: stretch; gap: 10px; }
            .btn { width: 100%; }
            
            .row-flex { flex-direction: column; gap: 10px; }
            .action-grid { grid-template-columns: 1fr; } /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏±‡πâ‡∏á */
        }
    </style>

    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>
</head>
<body>

    <div class="container">
        <div class="header">
            <h2><i class="fas fa-clock"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤ (Level 1)</h2>
            <a href="menu.html" class="back-btn"><i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
        </div>

        <div class="toolbar">
            <div class="form-group">
                <label><i class="far fa-calendar-alt"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</label>
                <input type="date" id="filterDate">
            </div>
            <button class="btn btn-primary" onclick="loadData()">
                <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>
            <button class="btn btn-success" onclick="openAddModal()">
                <i class="fas fa-user-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </button>
        </div>

        <div class="table-wrapper">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th>‡∏£‡∏´‡∏±‡∏™</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th>
                        <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th style="text-align:center;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="6" style="text-align:center; padding: 30px; color:#94a3b8;">
                        <i class="fas fa-search fa-2x"></i><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- System Init ---
        if (typeof sbClient === 'undefined') {
            Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase (check config.js)', 'error');
        }

        // --- Helpers ---
        function getDBDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getCurrentTime() {
            const now = new Date();
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            return `${hh}:${mm}`;
        }

        function formatDateThai(dateStr) {
            if(!dateStr) return "-";
            const d = new Date(dateStr);
            return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear() + 543}`;
        }

        function generateLongID() {
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const r = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}${r}`;
        }

        // --- Start ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('filterDate').value = getDBDateString();
            loadData();
        });

        // --- Load Data ---
        async function loadData() {
            const date = document.getElementById('filterDate').value;
            const tbody = document.getElementById('tableBody');
            
            if(!date) return;
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

            try {
                const { data, error } = await sbClient
                    .from(TAS_CONFIG.TABLE_SOURCE) 
                    .select('*')
                    .eq('work_date', date)
                    .order('time_in', { ascending: true });

                if (error) throw error;

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:30px; color:#64748b;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDateThai(date)}</td></tr>`;
                    return;
                }

                let html = '';
                data.forEach(row => {
                    const tIn = row.time_in ? row.time_in.substring(0, 5) : '-';
                    const tOut = row.time_out ? row.time_out.substring(0, 5) : '-';
                    
                    html += `
                        <tr>
                            <td>${row.personnel_id || ''}</td>
                            <td>${row.full_name || ''}</td>
                            <td style="color:var(--success); font-weight:bold;">${tIn}</td>
                            <td style="color:var(--danger); font-weight:bold;">${tOut}</td>
                            <td>${formatDateThai(row.work_date)}</td>
                            <td style="text-align:center;">
                                <div style="display:flex; gap:5px; justify-content:center;">
                                    <button class="btn btn-warning" style="padding:6px 12px; width:auto;" onclick="openEditModal('${row.id}', '${row.personnel_id}', '${row.full_name}', '${tIn}', '${tOut}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger" style="padding:6px 12px; width:auto;" onclick="deleteRecord('${row.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;

            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="6" style="color:red;text-align:center;">‚ùå Error: ${err.message}</td></tr>`;
            }
        }

        // --- Add Modal (Responsive & Custom Buttons) ---
        async function openAddModal() {
            const curDate = document.getElementById('filterDate').value;
            const curTime = getCurrentTime();
            
            await Swal.fire({
                title: '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤',
                width: '95%', // ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
                background: '#fff',
                html: `
                    <div class="modal-body">
                        <div class="search-container">
                            <label style="font-weight:bold; color:var(--primary);">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠):</label>
                            <input id="search-box" style="margin-top:5px;" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô '‡∏™‡∏°')..." autocomplete="off">
                            <div id="search-results" class="search-results"></div>
                        </div>

                        <div class="row-flex">
                            <div style="flex:1">
                                <label>‡∏£‡∏´‡∏±‡∏™:</label>
                                <input id="swal-pid" class="readonly-input" readonly>
                            </div>
                            <div style="flex:2">
                                <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</label>
                                <input id="swal-name" class="readonly-input" readonly>
                            </div>
                        </div>
                        
                        <div class="row-flex">
                            <div style="flex:1">
                                <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                                <input type="date" id="swal-date" value="${curDate}">
                            </div>
                            <div style="flex:1">
                                <label>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤:</label>
                                <input type="time" id="swal-time" value="${curTime}" style="font-weight:bold; font-size:1.1rem; text-align:center;">
                            </div>
                        </div>

                        <div class="action-grid">
                            <button class="btn-action btn-in" onclick="saveManualData('in')">
                                <i class="fas fa-sign-in-alt fa-2x"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤
                            </button>
                            <button class="btn-action btn-out" onclick="saveManualData('out')">
                                <i class="fas fa-sign-out-alt fa-2x"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å
                            </button>
                        </div>
                    </div>
                `,
                showConfirmButton: false, // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° OK ‡πÄ‡∏î‡∏¥‡∏°
                showCloseButton: true,
                
                // Logic ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                didOpen: () => {
                    const searchBox = Swal.getPopup().querySelector('#search-box');
                    const resultsBox = Swal.getPopup().querySelector('#search-results');
                    const pidInput = Swal.getPopup().querySelector('#swal-pid');
                    const nameInput = Swal.getPopup().querySelector('#swal-name');

                    searchBox.addEventListener('input', async (e) => {
                        const keyword = e.target.value.trim();
                        if (keyword.length < 1) { resultsBox.style.display = 'none'; return; }

                        const { data } = await sbClient.from('Personnel')
                            .select('personnel_id, name').ilike('name', `%${keyword}%`).limit(5);

                        resultsBox.innerHTML = '';
                        if (data && data.length > 0) {
                            resultsBox.style.display = 'block';
                            data.forEach(p => {
                                const item = document.createElement('div');
                                item.className = 'search-item';
                                item.innerHTML = `<b>${p.name}</b> <small>(${p.personnel_id})</small>`;
                                item.onclick = () => {
                                    pidInput.value = p.personnel_id;
                                    nameInput.value = p.name;
                                    searchBox.value = '';
                                    resultsBox.style.display = 'none';
                                };
                                resultsBox.appendChild(item);
                            });
                        } else { resultsBox.style.display = 'none'; }
                    });
                }
            });
        }

        // --- Save Function (Triggered by Custom Buttons) ---
        window.saveManualData = async (type) => {
            const pid = document.getElementById('swal-pid').value;
            const name = document.getElementById('swal-name').value;
            const date = document.getElementById('swal-date').value;
            const time = document.getElementById('swal-time').value;

            if (!pid) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return; }
            if (!date || !time) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤'); return; }

            try {
                const newID = generateLongID();
                const timeIn = (type === 'in') ? time : null;
                const timeOut = (type === 'out') ? time : null;
                
                // ‡πÅ‡∏™‡∏î‡∏á Loading
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                const { error } = await sbClient.from(TAS_CONFIG.TABLE_SOURCE).insert([{
                    id: newID, personnel_id: pid, full_name: name,
                    work_date: date, time_in: timeIn, time_out: timeOut
                }]);

                if (error) throw error;

                // Success Feedback
                await Swal.fire({
                    icon: 'success',
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: `‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${type==='in'?'‡πÄ‡∏Ç‡πâ‡∏≤':'‡∏≠‡∏≠‡∏Å'} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`,
                    timer: 1500, showConfirmButton: false
                });
                
                loadData(); // Refresh Table

            } catch (err) {
                Swal.fire('Error', err.message, 'error');
            }
        };

        // --- Edit Modal ---
        async function openEditModal(id, pid, name, tIn, tOut) {
            tIn = (tIn === '-') ? '' : tIn;
            tOut = (tOut === '-') ? '' : tOut;

            const { value: f } = await Swal.fire({
                title: `‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${name}`,
                width: '90%',
                html: `
                    <div class="modal-body">
                        <div class="row-flex">
                            <div style="flex:1">
                                <label style="color:var(--success); font-weight:bold;">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤:</label>
                                <input type="time" id="edit-in" value="${tIn}" style="text-align:center;">
                            </div>
                            <div style="flex:1">
                                <label style="color:var(--danger); font-weight:bold;">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å:</label>
                                <input type="time" id="edit-out" value="${tOut}" style="text-align:center;">
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
                confirmButtonColor: '#3b82f6',
                preConfirm: () => ({
                    in: document.getElementById('edit-in').value,
                    out: document.getElementById('edit-out').value
                })
            });

            if (f) {
                try {
                    const { error } = await sbClient.from(TAS_CONFIG.TABLE_SOURCE)
                        .update({ time_in: f.in || null, time_out: f.out || null })
                        .eq('id', id);

                    if (error) throw error;
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    loadData();
                } catch (err) {
                    Swal.fire('Error', err.message, 'error');
                }
            }
        }

        // --- Delete ---
        function deleteRecord(id) {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?',
                text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const { error } = await sbClient.from(TAS_CONFIG.TABLE_SOURCE).delete().eq('id', id);
                    if (!error) {
                        loadData();
                        Swal.fire('Deleted!', '‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                    } else {
                        Swal.fire('Error', error.message, 'error');
                    }
                }
            })
        }
    </script>
</body>
</html>
