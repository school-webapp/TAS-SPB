<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ผู้ไม่มีข้อมูลการลงเวลา - TAS-SPB</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>

    <style>
        :root { --primary: #ec4899; --bg: #f3f4f6; --text: #1f2937; --muted: #6b7280; --border: #e5e7eb; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); color: var(--text); padding: 10px; height: 100vh; display: flex; flex-direction: column; }
        .container { max-width: 800px; margin: 0 auto; width: 100%; flex: 1; display: flex; flex-direction: column; }
        .card-header { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 10px; border-bottom: 4px solid var(--primary); }
        .content-scroll { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .data-item { 
            background: white; padding: 15px; border-radius: 15px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 5px solid var(--danger); box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .status-badge { background: #fee2e2; color: #ef4444; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .loading-box { text-align: center; padding: 40px; color: var(--muted); }
    </style>
</head>
<body>

<div class="container">
    <div class="card-header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="font-size:1.1rem;"><i class="fas fa-user-slash"></i> ผู้ไม่มีข้อมูลการลงเวลา</h2>
            <a href="menu.html" style="color:var(--primary);"><i class="fas fa-home fa-lg"></i></a>
        </div>
        <div style="margin-top:10px; font-size:0.85rem; color:var(--muted);">
            วันที่ตรวจสอบ: <span id="display-date" style="font-weight:bold; color:var(--primary);"></span>
        </div>
    </div>

    <div id="loading" class="loading-box">
        <i class="fas fa-spinner fa-spin fa-2x"></i><br><br>กำลังตรวจสอบข้อมูลจากทุกช่องทาง...
    </div>

    <div class="content-scroll" id="main-list" style="display:none;">
        <div id="absent-list" class="data-list"></div>
    </div>
</div>

<script>
    const today = new Date().toISOString().split('T')[0];
    // แสดงวันที่ วว/ดด/ปปปป ไทย
    document.getElementById('display-date').innerText = new Date().toLocaleDateString('th-TH', {day:'2-digit', month:'2-digit', year:'numeric'});

    document.addEventListener('DOMContentLoaded', async () => {
        const user = JSON.parse(localStorage.getItem('tas_user') || '{}');
        if (user.level != '1' && user.level != '2') { window.location.replace('menu.html'); return; }
        checkAbsentees();
    });

    async function checkAbsentees() {
        try {
            // 1. ดึงพนักงานทั้งหมด
            const { data: allPersonnel } = await sbClient.from('Personnel').select('personnel_id, name');

            // 2. ดึงข้อมูลจาก TimeStamp ใน DB วันนี้
            const { data: dbAttended } = await sbClient.from('TimeStamp').select('personnel_id').eq('work_date', today);

            // 3. ดึงข้อมูลจาก URL (จำลองหลักการของ process.html)
            let webAttendedIds = [];
            const { data: config } = await sbClient.from('Settings').select('value').eq('key', 'data_url').single();
            if (config?.value) {
                try {
                    const urlDate = today.split('-').reverse().join(''); // DDMMYYYY
                    const finalUrl = `https://corsproxy.io/?${encodeURIComponent(config.value + urlDate + '/')}`;
                    const res = await fetch(finalUrl);
                    if (res.ok) {
                        const html = await res.text();
                        const doc = new DOMParser().parseFromString(html, "text/html");
                        const rows = (doc.getElementById('mainTable') || doc.querySelector('table'))?.querySelectorAll('tr') || [];
                        rows.forEach(row => {
                            const pid = row.querySelectorAll('td')[0]?.innerText.trim();
                            if (pid && !isNaN(pid)) webAttendedIds.push(pid);
                        });
                    }
                } catch (e) { console.error("Web fetch failed", e); }
            }

            // 4. รวบรวม ID คนที่มีข้อมูลแล้ว
            const busyIds = new Set([
                ...(dbAttended || []).map(r => r.personnel_id),
                ...webAttendedIds
            ]);

            // 5. กรองคนไม่มีข้อมูล
            const absentees = allPersonnel.filter(p => !busyIds.has(p.personnel_id));

            renderList(absentees);
        } catch (err) {
            Swal.fire('Error', 'ไม่สามารถโหลดข้อมูลได้', 'error');
        }
    }

    function renderList(list) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('main-list').style.display = 'block';
        
        const container = document.getElementById('absent-list');
        if (list.length === 0) {
            container.innerHTML = '<center style="padding:40px; color:#9ca3af;">-- วันนี้พนักงานทุกคนลงเวลาครบแล้ว --</center>';
            return;
        }

        container.innerHTML = list.map(p => `
            <div class="data-item">
                <div>
                    <strong style="font-size:1rem;">${p.name}</strong><br>
                    <small style="color:var(--muted);">รหัสพนักงาน: ${p.personnel_id}</small>
                </div>
                <span class="status-badge">ยังไม่มีข้อมูล</span>
            </div>
        `).join('');
    }
</script>
</body>
</html>
