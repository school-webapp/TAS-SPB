<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ผู้ไม่มีข้อมูลการลงเวลา - TAS-SPB</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="supabase.js"></script>
    <script src="sweetalert2.js"></script>
    <script src="config.js"></script>
    <style>
        :root { --primary: #ec4899; --bg: #f3f4f6; --text: #1f2937; --danger: #ef4444; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); padding: 10px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .container { max-width: 800px; margin: 0 auto; width: 100%; flex: 1; display: flex; flex-direction: column; }
        .card-header { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 10px; border-bottom: 4px solid var(--primary); }
        .content-area { flex: 1; overflow-y: auto; display: flex; flex-direction: column; padding-bottom: 20px; }
        .data-item { background: white; padding: 15px; border-radius: 15px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--danger); height: 85px; }
        .status-badge { background: #fee2e2; color: var(--danger); padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .pager { display: flex; justify-content: center; align-items: center; gap: 20px; padding: 15px 0; }
        .btn-page { width: 40px; height: 40px; border-radius: 12px; border: 1px solid #ddd; background: white; cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <div class="card-header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="font-size:1.1rem;"><i class="fas fa-user-slash"></i> ผู้ไม่มีข้อมูลการลงเวลา</h2>
            <a href="menu.html" style="color:var(--primary);"><i class="fas fa-home fa-lg"></i></a>
        </div>
        <div style="margin-top:8px; font-size:0.85rem; color:#666;">
            วันที่ตรวจสอบ: <span id="display-date" style="font-weight:bold; color:var(--primary);"></span>
        </div>
    </div>

    <div class="content-area" id="main-area">
        <div id="absent-list"></div>
    </div>

    <div class="pager" id="pager-ui" style="display:none;">
        <button class="btn-page" id="prevBtn" onclick="changePage(-1)"><i class="fas fa-chevron-left"></i></button>
        <span id="pageInfo" style="font-weight:bold;">หน้า 1 / 1</span>
        <button class="btn-page" id="nextBtn" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<script>
    // ตั้งค่าเขตเวลาประเทศไทย
    const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Bangkok"}));
    const todayDB = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
    let allAbsentees = [], currentPage = 1;

    // วันที่แบบ วว/ดด/ปปปป ไทย
    document.getElementById('display-date').innerText = now.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });

    document.addEventListener('DOMContentLoaded', async () => {
        const user = JSON.parse(localStorage.getItem('tas_user') || '{}');
        if (!user.personnel_id) { window.location.replace('login.html'); return; }

        // ระบบตรวจสอบสิทธิ์รายบุคคล
        let hasAccess = user.level == '1';
        if (!hasAccess) {
            const { data } = await sbClient.from('PagePermissions').select('*').eq('page_name', 'absent_report.html').eq('user_id', user.personnel_id).single();
            if (data) hasAccess = true;
        }

        if (!hasAccess) {
            Swal.fire({ icon: 'error', title: 'ปฏิเสธการเข้าถึง', text: 'คุณไม่มีสิทธิ์ในหน้านี้' }).then(() => window.location.replace('menu.html'));
            return;
        }
        await fetchData();
    });

    async function fetchData() {
        const { data: allP } = await sbClient.from('Personnel').select('personnel_id, name').order('name');
        const { data: dbAtt } = await sbClient.from('TimeStamp').select('personnel_id').eq('work_date', todayDB);
        
        let webIds = [];
        const { data: cfg } = await sbClient.from('Settings').select('value').eq('key', 'data_url').single();
        if (cfg?.value) {
            let base = cfg.value.trim();
            if (!base.endsWith('/')) base += '/'; // เติม / ก่อนวันที่
            const dateStr = String(now.getDate()).padStart(2, '0') + String(now.getMonth() + 1).padStart(2, '0') + now.getFullYear();
            const url = `${base}${dateStr}/`; // รูปแบบ DDMMYYYY/
            
            try {
                const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                const html = await res.text();
                const doc = new DOMParser().parseFromString(html, "text/html");
                const rows = doc.querySelector('table')?.querySelectorAll('tr') || [];
                rows.forEach(r => { const pid = r.cells[0]?.innerText.trim(); if(pid && !isNaN(pid)) webIds.push(pid); });
            } catch(e) {}
        }

        const busy = new Set([...(dbAtt || []).map(r => r.personnel_id), ...webIds]);
        allAbsentees = (allP || []).filter(p => !busy.has(p.personnel_id));
        render();
    }

    function getPageSize() { return Math.floor(document.getElementById('main-area').clientHeight / 93) || 4; }

    function render() {
        const size = getPageSize(), total = Math.ceil(allAbsentees.length / size) || 1;
        const start = (currentPage - 1) * size;
        const data = allAbsentees.slice(start, start + size);
        
        document.getElementById('absent-list').innerHTML = data.map(p => `
            <div class="data-item">
                <div><strong>${p.name}</strong><br><small>ID: ${p.personnel_id}</small></div>
                <span class="status-badge">ไม่มีข้อมูล</span>
            </div>
        `).join('') || '<center style="padding:40px; color:#999;">-- ครบถ้วน --</center>';

        document.getElementById('pager-ui').style.display = allAbsentees.length ? 'flex' : 'none';
        document.getElementById('pageInfo').innerText = `หน้า ${currentPage} / ${total}`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage >= total;
    }

    function changePage(s) { currentPage += s; render(); }
</script>
</body>
</html>
